{% extends "base.html" %}

{% block title %}å‘è´§ç®¡ç† - è‹èµ‹ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 text-white mb-1">å‘è´§ç®¡ç†</h1>
            <p class="text-white-50 mb-0">ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç«™ç‚¹çš„å‘è´§æ“ä½œ</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-info" id="printListBtn">
                <i class="bi bi-printer me-1"></i> æ‰“å°ä»Šæ—¥æ¸…å•
            </button>
            <button class="btn btn-outline-warning" id="printPendingBtn">
                <i class="bi bi-printer me-1"></i> æ‰“å°æœªå‘è´§æ¸…å•
            </button>
            <button class="btn btn-outline-light" onclick="loadOrders()">
                <i class="bi bi-arrow-repeat me-1"></i> åˆ·æ–°
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card bg-dark border-secondary border-opacity-25 mb-4">
        <div class="card-body py-2 px-3">
            <div class="row align-items-center g-3">
                <div class="col-md-2">
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="siteFilter">
                        <option value="">å…¨éƒ¨ç«™ç‚¹</option>
                        {% for site in sites %}
                        <option value="{{ site.url }}">{{ site.manager }} - {{ site.url.replace('https://www.',
                            '').replace('https://', '') }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="managerFilter">
                        <option value="">å…¨éƒ¨è´Ÿè´£äºº</option>
                        {% for manager in managers %}
                        <option value="{{ manager }}">{{ manager }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="text"
                        class="form-control form-select-sm bg-dark text-white border-secondary datepicker" id="dateFrom"
                        placeholder="å¼€å§‹æ—¥æœŸ">
                </div>
                <div class="col-md-2">
                    <input type="text"
                        class="form-control form-select-sm bg-dark text-white border-secondary datepicker" id="dateTo"
                        placeholder="ç»“æŸæ—¥æœŸ">
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-select-sm bg-dark text-white border-secondary"
                        id="searchInput" placeholder="æœç´¢è®¢å•å·...">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-sm btn-primary w-100" onclick="loadOrders()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <div class="col-md-1 text-end">
                    <span class="badge bg-warning text-dark d-block mb-1" id="pendingCount">å¾…å‘è´§: 0</span>
                    <span class="badge bg-info d-block" id="shippedCount">å·²å‘è´§: 0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs border-secondary mb-3" id="shippingTabs">
        <li class="nav-item">
            <a class="nav-link active text-white" data-bs-toggle="tab" href="#pendingTab">
                <i class="bi bi-box-seam me-1"></i> å¾…å‘è´§
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white-50" data-bs-toggle="tab" href="#shippedTab">
                <i class="bi bi-truck me-1"></i> å·²å‘è´§
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Pending Orders Tab -->
        <div class="tab-pane fade show active" id="pendingTab">
            <div class="card data-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover align-middle mb-0"
                            style="--bs-table-bg: transparent;">
                            <thead>
                                <tr>
                                    <th class="ps-3">è®¢å•</th>
                                    <th>å®¢æˆ·ä¿¡æ¯</th>
                                    <th>äº§å“æ˜ç»†</th>
                                    <th class="text-end">æ€»æ•°é‡</th>
                                    <th class="text-end">è¿è´¹</th>
                                    <th class="text-end">è®¢å•é‡‘é¢</th>
                                    <th class="text-end pe-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="pendingOrdersBody">
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipped Orders Tab -->
        <div class="tab-pane fade" id="shippedTab">
            <div class="card data-card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="ps-3">è®¢å•</th>
                                    <th>å®¢æˆ·</th>
                                    <th>äº§å“æ˜ç»†</th>
                                    <th class="text-end">æ€»æ•°é‡</th>
                                    <th class="text-end">è¿è´¹</th>
                                    <th class="text-end">è®¢å•é‡‘é¢</th>
                                    <th class="text-center">è¿å•ä¿¡æ¯</th>
                                    <th class="text-end pe-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="shippedOrdersBody">
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ship Order Modal -->
<div class="modal fade" id="shipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="bi bi-truck me-2"></i>å‘è´§</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="shipOrderId">
                <div class="mb-3">
                    <label class="form-label text-white-50">è®¢å•å·</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="shipOrderNumber"
                        readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">å®¢æˆ·</label>
                    <div id="shipCustomerInfo" class="text-white"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">ç‰©æµå•† *</label>
                    <select class="form-select bg-dark text-white border-secondary" id="shipCarrier" required>
                        <option value="">é€‰æ‹©ç‰©æµå•†</option>
                        {% for carrier in carriers %}
                        <option value="{{ carrier.slug }}">{{ carrier.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">è¿½è¸ªå·ç  *</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" id="shipTrackingNumber"
                        required placeholder="è¾“å…¥è¿å•å·">
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="shipSendEmail" checked>
                    <label class="form-check-label text-white-50" for="shipSendEmail">å‘é€é‚®ä»¶é€šçŸ¥å®¢æˆ·</label>
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">å‘è´§æ¨¡å¼</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="shipMode" id="modeAPI" value="api" checked>
                        <label class="btn btn-outline-primary" for="modeAPI">
                            <i class="bi bi-plug me-1"></i>APIæ¨¡å¼
                        </label>
                        <input type="radio" class="btn-check" name="shipMode" id="modeNote" value="note">
                        <label class="btn btn-outline-secondary" for="modeNote">
                            <i class="bi bi-chat-left-text me-1"></i>å¤‡æ³¨æ¨¡å¼
                        </label>
                    </div>
                    <small class="text-muted d-block mt-1">APIæ¨¡å¼ç›´æ¥å†™å…¥ç‰©æµä¿¡æ¯ï¼Œå¤‡æ³¨æ¨¡å¼é€šè¿‡è®¢å•å¤‡æ³¨å‘é€</small>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmShipBtn">
                    <i class="bi bi-truck me-1"></i> ç¡®è®¤å‘è´§
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="bi bi-chat-left-text me-2"></i>æ·»åŠ å¤‡æ³¨</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="noteOrderId">
                <div class="mb-3">
                    <label class="form-label text-white-50">è®¢å•å·: <span id="noteOrderNumber"
                            class="text-white"></span></label>
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">å¤‡æ³¨å†…å®¹ *</label>
                    <textarea class="form-control bg-dark text-white border-secondary" id="noteContent" rows="4"
                        placeholder="è¾“å…¥å¤‡æ³¨å†…å®¹..."></textarea>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="noteNotifyCustomer">
                    <label class="form-check-label text-white-50" for="noteNotifyCustomer">
                        <i class="bi bi-envelope me-1"></i> å‘é€é‚®ä»¶é€šçŸ¥å®¢æˆ·
                    </label>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmNoteBtn">ä¿å­˜å¤‡æ³¨</button>
            </div>
        </div>
    </div>
</div>

<!-- Print Label Modal -->
<div class="modal fade" id="printLabelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="bi bi-printer me-2"></i>æ‰“å°é¢å•</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="printLabelContent">
                <!-- Label content will be loaded here -->
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="bi bi-printer me-1"></i> æ‰“å°
                </button>
            </div>
        </div>
    </div>

    <!-- Email Logs Modal -->
    <div class="modal fade" id="emailLogsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark border border-secondary border-opacity-25">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title text-white"><i class="bi bi-envelope me-2"></i>é‚®ä»¶å‘é€è®°å½•</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="emailLogsSiteId">

                    <!-- Email Stats -->
                    <div class="row mb-4" id="emailStatsRow">
                        <div class="col-md-4">
                            <div class="card bg-success bg-opacity-10 border-success border-opacity-25 h-100">
                                <div class="card-body text-center py-3">
                                    <div class="text-success h3 mb-0" id="emailStatsSent">0</div>
                                    <small class="text-success-50">å‘é€æˆåŠŸ</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-danger bg-opacity-10 border-danger border-opacity-25 h-100">
                                <div class="card-body text-center py-3">
                                    <div class="text-danger h3 mb-0" id="emailStatsFailed">0</div>
                                    <small class="text-danger-50">å‘é€å¤±è´¥</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info bg-opacity-10 border-info border-opacity-25 h-100">
                                <div class="card-body text-center py-3">
                                    <div class="text-info h3 mb-0" id="emailStatsRate">0%</div>
                                    <small class="text-info-50">æˆåŠŸç‡</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Logs Table -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-dark table-hover align-middle mb-0"
                            style="--bs-table-bg: transparent;">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>æ”¶ä»¶äºº</th>
                                    <th>ä¸»é¢˜</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="emailLogsTableBody">
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-muted">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-top border-secondary border-opacity-25">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize date pickers
            var dateConfig = {
                locale: 'zh',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'Yå¹´mæœˆdæ—¥',
                allowInput: true,
                disableMobile: true
            };
            flatpickr('#dateFrom', dateConfig);
            flatpickr('#dateTo', dateConfig);

            loadOrders();

            // Filter change handlers
            document.getElementById('siteFilter').addEventListener('change', loadOrders);
            document.getElementById('managerFilter').addEventListener('change', loadOrders);
            document.getElementById('dateFrom').addEventListener('change', loadOrders);
            document.getElementById('dateTo').addEventListener('change', loadOrders);

            // Search enter key
            document.getElementById('searchInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') loadOrders();
            });

            // Tab change - reload data
            document.querySelectorAll('#shippingTabs a').forEach(tab => {
                tab.addEventListener('shown.bs.tab', loadOrders);
            });

            // Confirm ship button
            document.getElementById('confirmShipBtn').addEventListener('click', shipOrder);

            // Confirm note button
            document.getElementById('confirmNoteBtn').addEventListener('click', addNote);

            // Print list button
            document.getElementById('printListBtn').addEventListener('click', printTodayList);
            document.getElementById('printPendingBtn').addEventListener('click', printPendingList);
        });

        function loadOrders() {
            const source = document.getElementById('siteFilter').value;
            const manager = document.getElementById('managerFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const search = document.getElementById('searchInput').value;

            const params = new URLSearchParams({
                source: source,
                manager: manager,
                start_date: dateFrom,
                end_date: dateTo,
                search: search
            });

            // Load pending orders
            fetch(`/api/shipping/pending?${params.toString()}`)
                .then(res => res.json())
                .then(orders => {
                    document.getElementById('pendingCount').textContent = `å¾…å‘è´§: ${orders.length}`;
                    const tbody = document.getElementById('pendingOrdersBody');
                    if (orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">æš‚æ— å¾…å‘è´§è®¢å•</td></tr>';
                        return;
                    }
                    tbody.innerHTML = orders.map(o => `
                <tr>
                    <td class="ps-3">
                        <div class="fw-bold"><a href="javascript:void(0)" onclick="showOrderDetail(${o.id})" class="text-info text-decoration-none">#${o.number}</a></div>
                        <small class="text-muted">${o.manager ? '<span class="badge bg-info bg-opacity-25 text-info me-1">' + o.manager + '</span>' : ''}${o.source}</small>
                    </td>

                    <td>
                        <div class="fw-bold mb-1"><a href="javascript:void(0)" onclick="showCustomerDetail('${o.customer_email}')" class="text-white text-decoration-none">${o.customer_name}</a></div>
                        
                        <!-- Contact Info -->
                        <div class="mb-2">
                            ${o.customer_phone ? `<div class="d-flex align-items-center mb-1"><i class="bi bi-telephone text-secondary me-2"></i><span class="text-light small">${o.customer_phone}</span></div>` : ''}
                            ${o.customer_social ? `<div class="d-flex align-items-center mb-1"><i class="bi bi-whatsapp text-success me-2"></i><span class="text-light small">${o.customer_social}</span></div>` : ''}
                            <div class="d-flex align-items-center"><i class="bi bi-envelope text-secondary me-2"></i><span class="text-secondary small text-break">${o.customer_email}</span></div>
                        </div>

                        <!-- Smart Shipping Info -->
                        <div class="mt-1">
                            ${(() => {
                            const method = (o.shipping_method || '').toLowerCase();
                            const isInPost = o.customer_inpost_id || method.includes('inpost') || method.includes('paczkomat');
                            const isDPD = method.includes('dpd');

                            if (isInPost) {
                                return `<div>
                                        <div class="d-flex align-items-center">
                                            <span class="badge me-2" style="background-color: #FFCC00; color: #000; font-weight: 700;">InPost</span>
                                            <span class="text-white small font-monospace">${o.customer_inpost_id || ''}</span>
                                        </div>
                                        ${o.customer_address_2 ? `<div class="text-warning small mt-1 font-monospace"><i class="bi bi-geo-alt me-1"></i>${o.customer_address_2}</div>` : ''}
                                        ${!o.customer_inpost_id ? `<div class="text-muted small text-break mt-1">${o.customer_address || ''}</div>` : ''}
                                    </div>`;
                            } else if (isDPD) {
                                return `<div>
                                        <div class="mb-1"><span class="badge bg-primary text-white small">${o.shipping_method}</span></div>
                                        <div class="text-muted small text-break">${o.customer_address || '-'}</div>
                                    </div>`;
                            } else {
                                return `<div>
                                        <div class="mb-1"><span class="badge bg-secondary bg-opacity-50 text-light small">${o.shipping_method || 'Delivery'}</span></div>
                                        <div class="text-muted small text-break">${o.customer_address || '-'}</div>
                                    </div>`;
                            }
                        })()}
                        </div>
                    <td>
                        ${o.products.map(p => `
                        <div class="product-item" style="font-size: 0.9em;">
                            <span class="product-name">${p.name}</span>
                            <span class="product-qty">Ã—${p.quantity}</span>
                            <span class="product-total">${p.total.toFixed(2)} ${o.currency}</span>
                        </div>
                        `).join('')}
                    </td>
                    <td class="text-end text-white">${o.product_count}</td>
                    <td class="text-end text-info">${o.shipping_total.toFixed(2)}</td>
                    <td class="text-end"><strong>${o.total}</strong></td>
                    <td class="text-center">
                        ${o.tracking_number ? `
                            <div><strong class="text-white">${o.carrier_name}</strong></div>
                            ${o.tracking_url ?
                                `<a href="${o.tracking_url}" target="_blank" class="text-info text-decoration-none small"><i class="bi bi-link-45deg"></i>${o.tracking_number}</a>` :
                                `<small class="text-muted">${o.tracking_number}</small>`
                            }
                            <div class="text-muted small">${o.shipped_at || '-'}</div>
                        ` : '<span class="text-muted small">-</span>'}
                    </td>
                    <td class="text-end pe-3 text-nowrap">
                        <a href="javascript:void(0)" class="text-secondary me-3 text-decoration-none" onclick="openNoteModal(${o.id}, '${o.number}')" title="å¤‡æ³¨">
                            <i class="bi bi-chat-left-text"></i>
                        </a>
                        <a href="javascript:void(0)" class="text-info me-3 text-decoration-none" onclick="printLabel(${o.id})" title="æ‰“å°">
                            <i class="bi bi-printer"></i>
                        </a>
                        <button class="btn btn-sm btn-primary px-3" onclick="openShipModal(${o.id}, '${o.number}', '${o.customer_name}', '${o.customer_address.replace(/'/g, "\\'")}')">
                            <i class="bi bi-truck me-1"></i>å‘è´§
                        </button>
                    </td>
                </tr>
            `).join('');
                });

            // Load shipped orders
            fetch(`/api/shipping/shipped?${params.toString()}`)
                .then(res => res.json())
                .then(orders => {
                    document.getElementById('shippedCount').textContent = `å·²å‘è´§: ${orders.length}`;
                    const tbody = document.getElementById('shippedOrdersBody');
                    if (orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">æš‚æ— å·²å‘è´§è®¢å•</td></tr>';
                        return;
                    }
                    tbody.innerHTML = orders.map(o => `
                <tr>
                    <td class="ps-3">
                        <div class="fw-bold"><a href="javascript:void(0)" onclick="showOrderDetail(${o.id})" class="text-info text-decoration-none">#${o.number}</a></div>
                        <small class="text-muted">${o.manager ? '<span class="badge bg-info bg-opacity-25 text-info me-1">' + o.manager + '</span>' : ''}${o.source}</small>
                    </td>
                    <td>
                        <div class="text-white"><a href="javascript:void(0)" onclick="showCustomerDetail('${o.customer_email}')" class="text-white text-decoration-none">${o.customer_name}</a></div>
                        <small class="text-muted d-block" title="${o.customer_address || ''}">${o.customer_address || ''}</small>
                    </td>
                    <td>
                        ${o.products.map(p => `
                        <div class="product-item" style="font-size: 0.9em;">
                            <span class="product-name">${p.name}</span>
                            <span class="product-qty">Ã—${p.quantity}</span>
                            <span class="product-total">${p.total.toFixed(2)} ${o.currency}</span>
                        </div>
                        `).join('')}
                    </td>
                    <td class="text-end text-white">${o.product_count}</td>
                    <td class="text-end text-info">${o.shipping_total.toFixed(2)}</td>
                    <td class="text-end"><strong>${o.total}</strong></td>
                    <td class="text-center">
                        ${o.has_tracking ? (o.tracking_number ? `
                            <div><strong class="text-white">${o.carrier_name || o.carrier_slug || ''}</strong></div>
                            ${o.tracking_url ?
                                `<a href="${o.tracking_url}" target="_blank" class="text-info text-decoration-none small"><i class="bi bi-link-45deg"></i>${o.tracking_number}</a>` :
                                `<small class="text-muted">${o.tracking_number}</small>`
                            }
                            <div class="text-muted small">${o.shipped_at || '-'}</div>
                        ` : '<span class="text-muted small">-</span>') :
                            '<span class="text-warning small"><i class="bi bi-exclamation-triangle me-1"></i>æ— è¿½è¸ªå·</span>'}
                    </td>
                    <td class="text-end pe-3 text-nowrap">
                        <a href="javascript:void(0)" class="text-secondary text-decoration-none" onclick="openNoteModal(${o.id}, '${o.number}')" title="å¤‡æ³¨">
                            <i class="bi bi-chat-left-text"></i>
                        </a>
                    </td>
                </tr>
            `).join('');
                });
        }

        function openShipModal(orderId, orderNumber, customerName, customerAddress) {
            document.getElementById('shipOrderId').value = orderId;
            document.getElementById('shipOrderNumber').value = '#' + orderNumber;
            document.getElementById('shipCustomerInfo').innerHTML = `
        <div class="fw-bold">${customerName}</div>
        <small class="text-muted">${customerAddress}</small>
    `;
            document.getElementById('shipCarrier').value = '';
            document.getElementById('shipTrackingNumber').value = '';
            document.getElementById('shipSendEmail').checked = true;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('shipModal')).show();
        }

        // For orders already in on-hold status but without tracking
        function openShipModalForExisting(orderId, orderNumber, customerName) {
            document.getElementById('shipOrderId').value = orderId;
            document.getElementById('shipOrderNumber').value = '#' + orderNumber;
            document.getElementById('shipCustomerInfo').innerHTML = `
        <div class="fw-bold">${customerName}</div>
        <small class="text-warning">è¡¥å½•è¿½è¸ªå·ï¼ˆå·²å‘è´§è®¢å•ï¼‰</small>
    `;
            document.getElementById('shipCarrier').value = '';
            document.getElementById('shipTrackingNumber').value = '';
            document.getElementById('shipSendEmail').checked = false; // ä¸é»˜è®¤å‘é‚®ä»¶ï¼Œå› ä¸ºå¯èƒ½å·²ç»é€šçŸ¥è¿‡
            bootstrap.Modal.getOrCreateInstance(document.getElementById('shipModal')).show();
        }

        function shipOrder() {
            const orderId = document.getElementById('shipOrderId').value;
            const carrier = document.getElementById('shipCarrier').value;
            const trackingNumber = document.getElementById('shipTrackingNumber').value.trim();
            const sendEmail = document.getElementById('shipSendEmail').checked;
            const shippingMode = document.querySelector('input[name="shipMode"]:checked').value;

            if (!carrier || !trackingNumber) {
                alert('è¯·å¡«å†™ç‰©æµå•†å’Œè¿½è¸ªå·ç ');
                return;
            }

            const btn = document.getElementById('confirmShipBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>å¤„ç†ä¸­...';

            fetch('/api/shipping/ship', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_id: orderId,
                    carrier_slug: carrier,
                    tracking_number: trackingNumber,
                    send_email: sendEmail,
                    shipping_mode: shippingMode
                })
            })
                .then(res => res.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-truck me-1"></i> ç¡®è®¤å‘è´§';

                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('shipModal')).hide();
                        loadOrders();

                        if (data.warning) {
                            alert(data.message);
                        } else {
                            showToast(data.message, 'success');
                        }
                    } else {
                        alert('å‘è´§å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-truck me-1"></i> ç¡®è®¤å‘è´§';
                    alert('è¯·æ±‚å¤±è´¥: ' + err);
                });
        }

        function completeOrder(orderId) {
            if (!confirm('ç¡®è®¤å°†æ­¤è®¢å•æ ‡è®°ä¸ºå·²å®Œæˆï¼Ÿ')) return;

            fetch(`/api/shipping/complete/${orderId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        loadOrders();
                        showToast('è®¢å•å·²å®Œæˆ', 'success');
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                });
        }

        function openNoteModal(orderId, orderNumber) {
            document.getElementById('noteOrderId').value = orderId;
            document.getElementById('noteOrderNumber').textContent = '#' + orderNumber;
            document.getElementById('noteContent').value = '';
            document.getElementById('noteNotifyCustomer').checked = false;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('noteModal')).show();
        }

        function addNote() {
            const orderId = document.getElementById('noteOrderId').value;
            const note = document.getElementById('noteContent').value.trim();
            const notifyCustomer = document.getElementById('noteNotifyCustomer').checked;

            if (!note) {
                alert('è¯·è¾“å…¥å¤‡æ³¨å†…å®¹');
                return;
            }

            fetch(`/api/order/${orderId}/note`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note, notify_customer: notifyCustomer })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                        showToast(data.message, 'success');
                    } else {
                        alert('æ·»åŠ å¤‡æ³¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                });
        }

        function printLabel(orderId) {
            fetch(`/api/shipping/print/label/${orderId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Determine shipping method badge
                    const method = (data.shipping_method || '').toLowerCase();
                    const isInPost = data.customer_inpost_id || method.includes('inpost') || method.includes('paczkomat');
                    const isDPD = method.includes('dpd');

                    let shippingBadge = '';
                    if (isInPost) {
                        shippingBadge = '<span class="badge" style="background-color: #FFCC00; color: #000; font-weight: 700;">InPost</span>';
                    } else if (isDPD) {
                        shippingBadge = '<span class="badge bg-primary">DPD</span>';
                    } else {
                        shippingBadge = `<span class="badge bg-secondary">${data.shipping_method || 'Standard'}</span>`;
                    }

                    const content = `
                <div class="p-4 bg-white text-dark" style="max-width: 1000px; margin: 0 auto;">
                    <div class="text-center border-bottom pb-3 mb-4">
                        <h3>ğŸ“¦ å‘è´§é¢å•</h3>
                    </div>
                    
                    <!-- Order Info -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>è®¢å•å·:</strong> <span class="fs-5">#${data.order_number}</span>
                        </div>
                        <div class="col-6 text-end">
                            <strong>æ—¥æœŸ:</strong> ${data.date}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>æ¥æº:</strong> ${data.manager ? '<span class="badge bg-info">' + data.manager + '</span> ' : ''}${data.source}
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Two Column Layout -->
                    <div class="row">
                        <!-- Left: Customer Info -->
                        <div class="col-md-6 mb-3">
                            <h5 class="mb-3">ğŸ‘¤ æ”¶ä»¶äººä¿¡æ¯</h5>
                            <div class="ps-3">
                                <div class="mb-2"><strong>å§“å:</strong> ${data.customer_name}</div>
                                ${data.customer_phone ? `<div class="mb-2"><strong>ç”µè¯:</strong> <span class="text-primary">${data.customer_phone}</span></div>` : ''}
                                ${data.customer_social ? `<div class="mb-2"><strong>WhatsApp:</strong> <span class="text-success">${data.customer_social}</span></div>` : ''}
                                ${data.customer_email ? `<div class="mb-2"><strong>é‚®ç®±:</strong> <span class="text-muted small">${data.customer_email}</span></div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Right: Shipping Info -->
                        <div class="col-md-6 mb-3">
                            <h5 class="mb-3">ğŸšš é…é€ä¿¡æ¯</h5>
                            <div class="ps-3">
                                <div class="mb-2"><strong>é…é€æ–¹å¼:</strong> ${shippingBadge}</div>
                                ${data.customer_inpost_id ? `
                                    <div class="mb-2">
                                        <strong>InPost ID:</strong><br>
                                        <span class="font-monospace text-primary">${data.customer_inpost_id}</span>
                                    </div>
                                ` : ''}
                                ${data.customer_address_2 ? `
                                    <div class="mb-2">
                                        <strong>å–è´§ç‚¹:</strong>
                                        <div class="text-warning font-monospace small">${data.customer_address_2}</div>
                                    </div>
                                ` : ''}
                                ${data.shipping_total ? `<div class="mb-2"><strong>è¿è´¹:</strong> ${data.shipping_total} ${data.currency || ''}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Full Width Address -->
                    <div class="mb-4">
                        <strong>æ”¶è´§åœ°å€:</strong>
                        <div class="ps-3 border-start border-3 border-secondary mt-2 py-2" style="white-space: pre-wrap;">${data.customer_address}</div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Products -->
                    <div class="mb-4">
                        <h5 class="mb-3">ğŸ“¦ å•†å“æ¸…å•</h5>
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>å•†å“åç§°</th>
                                    <th class="text-center">æ•°é‡</th>
                                    <th class="text-end">é‡‘é¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.products.map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${p.name}</td>
                                    <td class="text-center"><strong>Ã—${p.qty}</strong></td>
                                    <td class="text-end">${p.total ? p.total.toFixed(2) + ' ' + data.currency : '-'}</td>
                                </tr>
                                `).join('')}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="2" class="text-end"><strong>å•†å“æ€»æ•°:</strong></td>
                                    <td class="text-center"><strong>${data.products.reduce((sum, p) => sum + p.qty, 0)}</strong></td>
                                    <td class="text-end"><strong>${data.total}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    ${data.tracking_number ? `
                    <hr class="my-3">
                    <div class="mb-3">
                        <h5 class="mb-3">ğŸ“ è¿½è¸ªä¿¡æ¯</h5>
                        <div class="ps-3">
                            <div class="mb-2"><strong>ç‰©æµå•†:</strong> ${data.carrier_name}</div>
                            <div class="mb-2"><strong>è¿½è¸ªå·:</strong> <span class="font-monospace fs-5 text-primary">${data.tracking_number}</span></div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
                    document.getElementById('printLabelContent').innerHTML = content;
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('printLabelModal')).show();
                });
        }

        function printTodayList() {
            fetch('/api/shipping/print/list')
                .then(res => res.json())
                .then(data => {
                    if (data.count === 0) {
                        alert('ä»Šæ—¥æš‚æ— å¾…å‘è´§è®¢å•');
                        return;
                    }
                    const content = `
                <div class="p-3 bg-white text-dark">
                    <div class="text-center border-bottom pb-3 mb-3">
                        <h4>ğŸ“‹ ä»Šæ—¥å‘è´§æ¸…å•</h4>
                        <p class="text-muted mb-0">${data.date} Â· å…± ${data.count} å•</p>
                    </div>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr style="font-size: 0.9em;">
                                <th style="width: 30px;">#</th>
                                <th style="width: 120px;">è®¢å•ä¿¡æ¯</th>
                                <th style="width: 250px;">å®¢æˆ· & è”ç³»æ–¹å¼</th>
                                <th style="width: 200px;">é…é€ä¿¡æ¯</th>
                                <th>å•†å“</th>
                                <th style="width: 80px;" class="text-end">é‡‘é¢</th>
                            </tr>
                        </thead>
                        <tbody style="font-size: 0.85em;">
                            ${data.orders.map((o, i) => {
                        const method = (o.shipping_method || '').toLowerCase();
                        const isInPost = o.customer_inpost_id || method.includes('inpost') || method.includes('paczkomat');
                        const isDPD = method.includes('dpd');
                        let shippingBadge = isInPost ? '<span class="badge" style="background-color: #FFCC00; color: #000; font-size: 0.75em;">InPost</span>' :
                            isDPD ? '<span class="badge bg-primary" style="font-size: 0.75em;">DPD</span>' :
                                `<span class="badge bg-secondary" style="font-size: 0.75em;">${o.shipping_method || 'Standard'}</span>`;

                        return `
                            <tr>
                                <td class="text-center"><strong>${i + 1}</strong></td>
                                <td>
                                    <div class="fw-bold">#${o.order_number}</div>
                                    <small class="text-muted">${o.manager ? '<span class="badge bg-info" style="font-size: 0.65em;">' + o.manager + '</span><br>' : ''}${o.source.replace('https://', '').replace('www.', '')}</small>
                                </td>
                                <td>
                                    <div class="fw-bold mb-1">${o.customer_name}</div>
                                    ${o.customer_phone ? `<div class="mb-1"><i class="bi bi-telephone text-primary me-1"></i><span class="font-monospace">${o.customer_phone}</span></div>` : ''}
                                    ${o.customer_social ? `<div class="mb-1"><i class="bi bi-whatsapp text-success me-1"></i><span>${o.customer_social}</span></div>` : ''}
                                    ${o.customer_email ? `<div class="text-muted" style="font-size: 0.75em;">${o.customer_email}</div>` : ''}
                                </td>
                                <td>
                                    <div class="mb-1">${shippingBadge}</div>
                                    ${o.customer_inpost_id ? `
                                        <div class="mb-1">
                                            <strong class="text-primary">InPost ID:</strong><br>
                                            <span class="font-monospace" style="font-size: 0.9em;">${o.customer_inpost_id}</span>
                                        </div>
                                    ` : ''}
                                    ${o.customer_address_2 ? `
                                        <div class="text-warning" style="font-size: 0.75em;">
                                            <i class="bi bi-geo-alt"></i> ${o.customer_address_2}
                                        </div>
                                    ` : ''}
                                    ${!isInPost ? `<div class="text-muted" style="font-size: 0.75em; max-width: 180px; word-wrap: break-word;">${o.customer_address}</div>` : ''}
                                    ${o.shipping_total ? `<div class="mt-1"><small><strong>è¿è´¹:</strong> ${o.shipping_total}</small></div>` : ''}
                                </td>
                                <td>
                                    <ul class="mb-0 ps-3" style="list-style: none; padding-left: 0;">
                                        ${o.products.map(p => `<li style="margin-bottom: 4px;">â€¢ ${p.name} <strong>Ã—${p.qty}</strong></li>`).join('')}
                                    </ul>
                                </td>
                                <td class="text-end"><strong>${o.total}</strong></td>
                            </tr>
                            `}).join('')}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="5" class="text-end"><strong>æ€»è®¡:</strong></td>
                                <td class="text-end"><strong>${data.orders.length} å•</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
                    document.getElementById('printLabelContent').innerHTML = content;
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('printLabelModal')).show();
                });
        }

        function printPendingList() {
            fetch('/api/shipping/print/pending')
                .then(res => res.json())
                .then(data => {
                    if (data.count === 0) {
                        alert('æš‚æ— æœªå‘è´§è®¢å•');
                        return;
                    }
                    const content = `
                <div class="p-3 bg-white text-dark">
                    <div class="text-center border-bottom pb-3 mb-3">
                        <h4>ğŸ“‹ æœªå‘è´§æ¸…å•</h4>
                        <p class="text-muted mb-0">${data.date} Â· å…± ${data.count} å•</p>
                    </div>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr style="font-size: 0.9em;">
                                <th style="width: 30px;">#</th>
                                <th style="width: 120px;">è®¢å•ä¿¡æ¯</th>
                                <th style="width: 250px;">å®¢æˆ· & è”ç³»æ–¹å¼</th>
                                <th style="width: 200px;">é…é€ä¿¡æ¯</th>
                                <th>å•†å“</th>
                                <th style="width: 80px;" class="text-end">é‡‘é¢</th>
                            </tr>
                        </thead>
                        <tbody style="font-size: 0.85em;">
                            ${data.orders.map((o, i) => {
                        const method = (o.shipping_method || '').toLowerCase();
                        const isInPost = o.customer_inpost_id || method.includes('inpost') || method.includes('paczkomat');
                        const isDPD = method.includes('dpd');
                        let shippingBadge = isInPost ? '<span class="badge" style="background-color: #FFCC00; color: #000; font-size: 0.75em;">InPost</span>' :
                            isDPD ? '<span class="badge bg-primary" style ="font-size: 0.75em;">DPD</span>' :
                                `<span class="badge bg-secondary" style="font-size: 0.75em;">${o.shipping_method || 'Standard'}</span>`;


                        return `
                            <tr>
                                <td class="text-center"><strong>${i + 1}</strong></td>
                                <td>
                                    <div class="fw-bold">#${o.order_number}</div>
                                    <small class="text-muted">${o.manager ? '<span class="badge bg-info" style="font-size: 0.65em;">' + o.manager + '</span><br>' : ''}${o.source.replace('https://', '').replace('www.', '')}</small>
                                </td>
                                <td>
                                    <div class="fw-bold mb-1">${o.customer_name}</div>
                                    ${o.customer_phone ? `<div class="mb-1"><i class="bi bi-telephone text-primary me-1"></i><span class="font-monospace">${o.customer_phone}</span></div>` : ''}
                                    ${o.customer_social ? `<div class="mb-1"><i class="bi bi-whatsapp text-success me-1"></i><span>${o.customer_social}</span></div>` : ''}
                                    ${o.customer_email ? `<div class="text-muted" style="font-size: 0.75em;">${o.customer_email}</div>` : ''}
                                </td>
                                <td>
                                    <div class="mb-1">${shippingBadge}</div>
                                    ${o.customer_inpost_id ? `
                                        <div class="mb-1">
                                            <strong class="text-primary">InPost ID:</strong><br>
                                            <span class="font-monospace" style="font-size: 0.9em;">${o.customer_inpost_id}</span>
                                        </div>
                                    ` : ''}
                                    ${o.customer_address_2 ? `
                                        <div class="text-warning" style="font-size: 0.75em;">
                                            <i class="bi bi-geo-alt"></i> ${o.customer_address_2}
                                        </div>
                                    ` : ''}
                                    ${!isInPost ? `<div class="text-muted" style="font-size: 0.75em; max-width: 180px; word-wrap: break-word;">${o.customer_address}</div>` : ''}
                                    ${o.shipping_total ? `<div class="mt-1"><small><strong>è¿è´¹:</strong> ${o.shipping_total}</small></div>` : ''}
                                </td>
                                <td>
                                    <ul class="mb-0 ps-3" style="list-style: none; padding-left: 0;">
                                        ${o.products.map(p => `<li style="margin-bottom: 4px;">â€¢ ${p.name} <strong>Ã—${p.qty}</strong></li>`).join('')}
                                    </ul>
                                </td>
                                <td class="text-end"><strong>${o.total}</strong></td>
                            </tr>
                            `}).join('')}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="5" class="text-end"><strong>æ€»è®¡:</strong></td>
                                <td class="text-end"><strong>${data.orders.length} å•</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
                    document.getElementById('printLabelContent').innerHTML = content;
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('printLabelModal')).show();
                });
        }

        function openEmailLogsModal(siteId) {
            document.getElementById('emailLogsSiteId').value = siteId;
            loadEmailStats(siteId);
            loadEmailLogs(siteId);
            bootstrap.Modal.getOrCreateInstance(document.getElementById('emailLogsModal')).show();
        }

        function loadEmailStats(siteId) {
            fetch(`/api/site/${siteId}/email-stats`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('emailStatsSent').textContent = data.sent || 0;
                        document.getElementById('emailStatsFailed').textContent = data.failed || 0;
                        document.getElementById('emailStatsRate').textContent = data.success_rate || '0%';
                    }
                })
                .catch(err => console.error('Error loading email stats:', err));
        }

        function loadEmailLogs(siteId, page = 1) {
            const tbody = document.getElementById('emailLogsTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">åŠ è½½ä¸­...</td></tr>';

            fetch(`/api/site/${siteId}/email-logs?page=${page}&per_page=20`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.logs && data.logs.length > 0) {
                        tbody.innerHTML = data.logs.map(log => `
                            <tr>
                                <td class="text-muted small">${log.created_at}</td>
                                <td class="text-white small">${log.recipient}</td>
                                <td class="text-white small" title="${log.subject}">${log.subject.substring(0, 40)}${log.subject.length > 40 ? '...' : ''}</td>
                                <td>
                                    ${log.status === 'sent'
                                ? '<span class="badge bg-success">å·²å‘é€</span>'
                                : '<span class="badge bg-danger" title="' + (log.error_message || '') + '">å¤±è´¥</span>'}
                                </td>
                            </tr>
                        `).join('');
                    } else if (data.success && (!data.logs || data.logs.length === 0)) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted"><i class="bi bi-inbox display-6 d-block mb-2 opacity-50"></i>æš‚æ— é‚®ä»¶è®°å½•</td></tr>';
                    } else {
                        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-warning"><i class="bi bi-exclamation-triangle me-1"></i>${data.error || 'åŠ è½½å¤±è´¥'}</td></tr>`;
                    }
                })
                .catch(err => {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger">è¯·æ±‚å¤±è´¥: ${err}</td></tr>`;
                });
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 show position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = 9999;
            toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }
    </script>

    <style>
        /* Tab styles for shipping page */
        #shippingTabs .nav-link {
            border: 1px solid transparent;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            padding: 0.75rem 1.25rem !important;
        }

        #shippingTabs .nav-link.active {
            background-color: rgba(102, 126, 234, 0.2) !important;
            border-color: rgba(102, 126, 234, 0.3) rgba(102, 126, 234, 0.3) transparent !important;
            color: #fff !important;
        }

        #shippingTabs .nav-link:not(.active):hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        @media print {

            .modal-header,
            .modal-footer,
            .navbar,
            .btn,
            nav {
                display: none !important;
            }

            .modal-dialog {
                max-width: 100%;
                margin: 0;
            }

            .modal-content {
                border: none !important;
                background: white !important;
            }
        }

        /* Product Item Styling - Matching Orders List Structure */
        .product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-name {
            flex: 1;
            color: #e2e8f0;
            font-size: 0.875rem;
            /* User requested no truncation */
            white-space: normal;
            line-height: 1.3;
            min-width: 0;
        }

        .product-qty {
            width: 40px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            font-size: 12px;
            line-height: 1;
            font-weight: 600;
            color: #A0AEC0;
            /* Prevent shrinking */
            flex-shrink: 0;
        }

        .product-total {
            width: 100px;
            text-align: right;
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            font-size: 13.6px;
            line-height: 20.4px;
            font-weight: 500;
            color: #38EF7D;
            /* Prevent shrinking */
            flex-shrink: 0;
        }
    </style>
    {% endblock %}