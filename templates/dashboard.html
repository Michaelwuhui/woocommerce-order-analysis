{% extends "base.html" %}

{% block title %}仪表板 - 苍赋管理系统{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% if api_error_sites and api_error_sites|length > 0 %}
    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert"
        style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(139, 0, 0, 0.1) 100%); border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 12px;">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill text-danger fs-4 me-3"></i>
            <div>
                <strong class="text-danger">API 连接异常</strong>
                <p class="mb-0 text-white-50 small">
                    以下站点 API 连接失败，无法同步订单数据：
                    {% for site in api_error_sites %}
                    <span class="badge bg-danger bg-opacity-25 text-danger ms-1">{{ site.url.replace('https://www.',
                        '').replace('https://', '') }}</span>
                    {% endfor %}
                    <a href="{{ url_for('settings') }}" class="text-info ms-2">前往设置</a>
                </p>
            </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    <!-- Filters -->
    <div class="quick-filters mb-4">
        <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="text-secondary me-2"><i class="bi bi-calendar-range me-1"></i>时间：</span>
                <a href="{{ url_for('dashboard', quick_date='this_month', source=source_filter) }}"
                    class="btn btn-quick {% if quick_date == 'this_month' %}active{% endif %}">本月至今</a>
                <a href="{{ url_for('dashboard', quick_date='last_month', source=source_filter) }}"
                    class="btn btn-quick {% if quick_date == 'last_month' %}active{% endif %}">上个月</a>
                <a href="{{ url_for('dashboard', quick_date='last_quarter', source=source_filter) }}"
                    class="btn btn-quick {% if quick_date == 'last_quarter' %}active{% endif %}">近三个月</a>
                <a href="{{ url_for('dashboard', quick_date='half_year', source=source_filter) }}"
                    class="btn btn-quick {% if quick_date == 'half_year' %}active{% endif %}">近半年</a>
                <a href="{{ url_for('dashboard', quick_date='one_year', source=source_filter) }}"
                    class="btn btn-quick {% if quick_date == 'one_year' %}active{% endif %}">近一年</a>
                <a href="{{ url_for('dashboard', quick_date='all', source=source_filter) }}"
                    class="btn btn-outline-secondary btn-sm {% if quick_date == 'all' %}active{% endif %}">全部</a>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-secondary"><i class="bi bi-person-badge me-1"></i>负责人：</span>
                    <select id="managerFilter" class="form-select form-select-sm" style="width: auto; min-width: 120px;"
                        onchange="window.location.href='{{ url_for('dashboard', quick_date=quick_date) }}&manager=' + this.value">
                        <option value="">全部负责人</option>
                        {% for manager in all_managers %}
                        <option value="{{ manager }}" {% if manager_filter==manager %}selected{% endif %}>
                            {{ manager }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-secondary"><i class="bi bi-globe me-1"></i>网站：</span>
                    <select id="sourceFilter" class="form-select form-select-sm" style="width: auto; min-width: 180px;"
                        onchange="window.location.href='{{ url_for('dashboard', quick_date=quick_date) }}&source=' + this.value">
                        <option value="">全部网站</option>
                        {% for source in sources %}
                        <option value="{{ source.source }}" {% if source_filter==source.source %}selected{% endif %}>
                            {{ source.source.replace('https://www.', '').replace('https://', '') }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl col-md-6">
            <div class="stat-card h-100 stat-card-primary">
                <div class="stat-icon">
                    <i class="bi bi-cart-check"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ "{:,}".format(stats.total_orders) }}</h3>
                    <p>总订单数</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card h-100 stat-card-success">
                <div class="stat-icon">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="stat-content text-end">
                    {% for currency, amount in stats.net_revenue_by_currency.items() %}
                    <div>{{ "{:,.2f}".format(amount) }} {{ currency }}</div>
                    {% endfor %}
                    <div class="mt-2"><span class="badge bg-warning text-dark">≈ ¥{{
                            "{:,.2f}".format(stats.net_revenue_cny) }}</span></div>
                    <p class="mb-0 mt-1">净销售额 (已除运费)</p>
                </div>
            </div>
        </div>
        <div class="col-xl col-md-6">
            <div class="stat-card h-100 stat-card-info">
                <div class="stat-icon">
                    <i class="bi bi-shop"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ source_data|length }}</h3>
                    <p>数据来源站点</p>
                </div>
            </div>
        </div>
        <div class="col-xl col-md-6">
            <div class="stat-card h-100 stat-card-warning">
                <div class="stat-icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div class="stat-content">
                    <h3>¥{{ "{:,.2f}".format(stats.total_revenue_cny / stats.valid_orders if stats.valid_orders > 0
                        else
                        0) }}</h3>
                    <p>平均订单金额 (CNY)</p>
                </div>
            </div>
        </div>
        <div class="col-xl col-md-6">
            <a href="{{ url_for('cancelled_analysis') }}" class="text-decoration-none">
                <div class="stat-card h-100 stat-card-danger">
                    <div class="stat-icon">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.cancelled_orders }}</h3>
                        <p>取消/失败订单 <i class="bi bi-arrow-right-short"></i></p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Trend Chart -->
        <div class="col-xl-8">
            <div class="card chart-card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart-line me-2"></i>
                        {% if trend_type == 'daily' %}日销售趋势{% else %}月度销售趋势{% endif %}
                        {% if source_filter %}<small class="text-muted ms-2">({{
                            source_filter.replace('https://www.',
                            '').replace('https://', '') }})</small>{% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Status Distribution -->
        <div class="col-xl-4">
            <div class="card chart-card">
                <div class="card-header">
                    <h5><i class="bi bi-pie-chart me-2"></i>订单状态分布</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Source Stats -->
        <div class="col-xl-4">
            <div class="card data-card">
                <div class="card-header">
                    <h5><i class="bi bi-globe me-2"></i>网站统计</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>网站</th>
                                    <th class="text-center">货币</th>
                                    <th class="text-end">订单数</th>
                                    <th class="text-end">销售额</th>
                                    <th class="text-end">净销售额</th>
                                    <th class="text-center">汇率</th>
                                    <th class="text-end">¥净额</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for source in source_data %}
                                <tr>
                                    <td>
                                        {% set mgr = site_managers.get(source.source, '') %}{% if mgr %}<span
                                            class="badge me-1" style="background:rgba(23,162,184,0.3);color:#17a2b8;">{{
                                            mgr }}</span>{% endif %}{% if source_display_mode != 'manager_only'
                                        %}<span class="source-badge">{{
                                            source.source.replace('https://www.', '').replace('https://', '')
                                            }}</span>{% endif %}
                                    </td>
                                    <td class="text-center"><span class="badge bg-secondary">{{ source.currency or
                                            'N/A'
                                            }}</span></td>
                                    <td class="text-end">{{ "{:,}".format(source.count) }}</td>
                                    <td class="text-end">{{ "{:,.2f}".format(source.revenue or 0) }} {{
                                        source.currency
                                        or '' }}</td>
                                    <td class="text-end text-success">{{ "{:,.2f}".format(source.net_revenue or 0)
                                        }} {{
                                        source.currency
                                        or '' }}</td>
                                    <td class="text-center"><span class="badge bg-info bg-opacity-25 text-info">{{
                                            "%.4f"|format(source.rate_to_cny) if source.rate_to_cny else '-'
                                            }}</span>
                                    </td>
                                    <td class="text-end text-warning">{% if source.net_revenue_cny %}¥{{
                                        "{:,.2f}".format(source.net_revenue_cny) }}{% else %}-{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="col-xl-8">
            <div class="card data-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-clock-history me-2"></i>最近订单</h5>
                    <a href="{{ url_for('orders') }}" class="btn btn-sm btn-outline-light">查看全部</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>订单号</th>
                                    <th>日期</th>
                                    <th>客户</th>
                                    <th>状态</th>
                                    <th class="text-end">产品数</th>
                                    <th class="text-end">金额</th>
                                    <th class="text-end">净额</th>
                                    <th class="text-center">汇率</th>
                                    <th class="text-end">¥净额</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr>
                                    <td><a href="javascript:void(0)" onclick="showOrderDetail('{{ order.id }}')"
                                            class="text-info text-decoration-none"><strong>#{{ order.number
                                                }}</strong></a></td>
                                    <td>{{ order.date_created|format_date }}</td>
                                    <td>
                                        <a href="javascript:void(0)"
                                            onclick="showCustomerDetail('{{ order.customer_email }}')"
                                            class="text-light text-decoration-none">{{ order.customer_name or '-'
                                            }}</a>

                                        {% if customer_attributes and order.customer_email in customer_attributes %}
                                        {% set attrs = customer_attributes[order.customer_email] %}
                                        {% if attrs.quality %}
                                        <span
                                            class="badge {{ attrs.quality.class }} bg-opacity-10 border border-opacity-25 ms-1"
                                            style="font-size: 0.7em; padding: 2px 6px;">
                                            <i class="bi bi-{{ attrs.quality.icon }}"></i> {{ attrs.quality.label }}
                                        </span>
                                        {% endif %}

                                        {% if attrs.order_count and attrs.order_count >= 1 %}
                                        <span
                                            class="badge text-secondary bg-opacity-10 border border-secondary border-opacity-25 ms-1"
                                            style="font-size: 0.7em; padding: 2px 6px;">
                                            <i class="bi bi-bag-check"></i> 第{{ attrs.order_count }}单
                                        </span>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td><span class="status-badge status-{{ order.status }}">{{
                                            order.status|status_label }}</span></td>
                                    <td class="text-end">{{ order.product_count }}</td>
                                    <td class="text-end"><strong>{{ order.total|format_currency }} {{ order.currency
                                            or
                                            '' }}</strong></td>
                                    <td class="text-end text-success">{{ "{:,.2f}".format(order.net_total or 0) }}
                                        {{
                                        order.currency or '' }}</td>
                                    <td class="text-center"><span class="badge bg-info bg-opacity-25 text-info small">{{
                                            "%.4f"|format(order.rate_to_cny) if order.rate_to_cny else '-' }}</span>
                                    </td>
                                    <td class="text-end text-warning">{% if order.net_total_cny %}¥{{
                                        "{:,.2f}".format(order.net_total_cny) }}{% else %}-{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            // Global variables
            var trendData = {{ trend_data | tojson | safe
        }};
    var trendType = '{{ trend_type }}';
    var statusData = {{ status_data | tojson | safe }};
    // Use backend calculated rate, default to 0 if missing
    var cnyRate = {{ cny_rate if cny_rate is defined else 0 }};

    // Check if Chart is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        document.getElementById('trendChart').parentNode.innerHTML = '<div class="alert alert-danger">图表组件加载失败，请检查网络连接</div>';
        return;
    }

    // Trend Chart
    var trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'bar',
        data: {
            labels: trendData.map(function (d) { return d.period; }),
            datasets: [{
                label: '订单数',
                data: trendData.map(function (d) { return d.orders; }),
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderRadius: trendType === 'daily' ? 4 : 8,
                yAxisID: 'y'
            }, {
                label: '销售额',
                data: trendData.map(function (d) { return d.revenue; }),
                type: 'line',
                borderColor: '#f093fb',
                backgroundColor: 'rgba(240, 147, 251, 0.1)',
                tension: 0.4,
                fill: true,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { labels: { color: '#fff' } },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            var label = context.dataset.label || '';
                            var value = context.parsed.y;
                            if (label === '销售额') {
                                var cnyValue = value * cnyRate;
                                return label + ': ' + value.toLocaleString('zh-CN', { minimumFractionDigits: 2 }) + ' (≈ ¥' + cnyValue.toLocaleString('zh-CN', { minimumFractionDigits: 2 }) + ')';
                            }
                            return label + ': ' + value;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: {
                        color: '#aaa',
                        maxRotation: 0,
                        callback: function (value, index) {
                            if (trendType === 'daily') {
                                var label = this.getLabelForValue(value);
                                // Simple date parsing
                                var parts = label.split('-');
                                if (parts.length === 3) {
                                    var date = new Date(label);
                                    var day = parts[2];
                                    var weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                                    var weekday = weekdays[date.getDay()];
                                    if (weekday) {
                                        return [day, weekday];
                                    }
                                }
                            }
                            return this.getLabelForValue(value);
                        }
                    }
                },
                y: {
                    position: 'left',
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#aaa' },
                    title: { display: true, text: '订单数', color: '#aaa' }
                },
                y1: {
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#aaa' },
                    title: { display: true, text: '销售额', color: '#aaa' }
                }
            }
        }
    });

    // Status Chart
    var statusCtx = document.getElementById('statusChart').getContext('2d');
    var total = statusData.reduce(function (sum, d) { return sum + d.count; }, 0);

    var statusColors = {
        'completed': '#28a745',
        'processing': '#17a2b8',
        'pending': '#ffc107',
        'on-hold': '#6c757d',
        'cancelled': '#dc3545',
        'failed': '#721c24',
        'refunded': '#fd7e14'
    };

    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(function (d) {
                var percent = total > 0 ? ((d.count / total) * 100).toFixed(1) : 0;
                return d.status + ' (' + percent + '%)';
            }),
            datasets: [{
                data: statusData.map(function (d) { return d.count; }),
                backgroundColor: statusData.map(function (d) { return statusColors[d.status] || '#6c757d'; }),
                borderWidth: 0,
                spacing: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    align: 'center',
                    labels: {
                        color: '#fff',
                        padding: 12,
                        boxWidth: 12,
                        boxHeight: 12,
                        usePointStyle: true,
                        pointStyle: 'rectRounded'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            var value = context.raw;
                            var percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return value + ' 订单 (' + percent + '%)';
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
        } catch (e) {
        console.error('Chart initialization error:', e);
        var errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.textContent = '图表加载错误: ' + e.message;
        document.querySelector('.chart-card .card-body').prepend(errorDiv);
    }
    });
</script>

<style>
    #statusChart {
        max-height: 220px !important;
    }
</style>
{% endblock %}