{% extends "base.html" %}

{% block title %}设置 - WooCommerce 订单分析
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white">确认删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-white">确定要删除这个站点吗？</p>
                <p class="text-white-50 small mb-0">这将不会删除已同步的历史订单数据，但会移除站点的连接配置。</p>
                <input type="hidden" id="deleteSiteId">
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block content %}
<!-- Sync Progress Modal -->
<div class="modal fade" id="syncProgressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white">正在同步数据...</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-white-50" id="syncStatusText">准备中...</span>
                        <span class="text-white-50" id="syncTimeText">00:00</span>
                    </div>
                    <div class="progress bg-secondary bg-opacity-25" style="height: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                            id="syncProgressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="card bg-black bg-opacity-25 border border-secondary border-opacity-25">
                    <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                        <small class="text-white-50">同步日志</small>
                    </div>
                    <div class="card-body p-2"
                        style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;"
                        id="syncLogConsole">
                        <!-- Logs will appear here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-primary" id="closeSyncModalBtn" disabled
                    data-bs-dismiss="modal">完成</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="h3 text-white mb-1">系统设置</h1>
                <p class="text-white-50 mb-0">管理 WooCommerce 站点连接和数据同步</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/users" class="btn btn-outline-light">
                    <i class="bi bi-people me-1"></i> 用户管理
                </a>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSiteModal">
                    <i class="bi bi-plus-lg me-1"></i> 添加站点
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="card bg-dark border-secondary border-opacity-25 mb-4">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center gap-2 border-end border-secondary border-opacity-25 pe-3">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="sourceDisplayToggle">
                                <label class="form-check-label text-white-50" for="sourceDisplayToggle">仅显示负责人</label>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="autoSyncToggle">
                                <label class="form-check-label text-white-50" for="autoSyncToggle">自动同步</label>
                            </div>
                            <select class="form-select form-select-sm bg-dark text-white border-secondary"
                                id="syncIntervalSelect" style="width: auto;">
                                <option value="300">每5分钟</option>
                                <option value="900" selected>每15分钟</option>
                                <option value="1800">每30分钟</option>
                                <option value="3600">每1小时</option>
                                <option value="7200">每2小时</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-info" id="viewSyncLogsBtn">
                            <i class="bi bi-journal-text me-1"></i> 同步日志
                        </button>
                        <button class="btn btn-sm btn-outline-info" id="deepSyncBtn">
                            <i class="bi bi-cloud-download me-1"></i> 深度同步
                        </button>
                        <button class="btn btn-sm btn-outline-warning" id="cleanAllBtn">
                            <i class="bi bi-trash2 me-1"></i> 清理同步
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="importFromScriptBtn">
                            <i class="bi bi-download me-1"></i> 从脚本导入
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="syncAllBtn">
                            <i class="bi bi-arrow-repeat me-1"></i> 快速同步
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sites List -->
    <div class="card data-card mb-4">
        <div class="card-header border-bottom border-secondary border-opacity-25 bg-transparent py-3">
            <h5 class="card-title text-white mb-0">已连接站点</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0" style="--bs-table-bg: transparent;">
                    <thead>
                        <tr>
                            <th class="ps-4">站点</th>
                            <th>Consumer Key</th>
                            <th>上次同步时间</th>
                            <th>状态</th>
                            <th class="text-end pe-4">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for site in sites %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="icon-box bg-primary bg-opacity-10 text-primary me-3"
                                        style="width: 32px; height: 32px; font-size: 1rem;">
                                        <i class="bi bi-globe"></i>
                                    </div>
                                    <div>
                                        {% if site.manager and site.manager|trim %}
                                        <span class="badge me-1"
                                            style="background: rgba(23, 162, 184, 0.3); color: #17a2b8;">{{
                                            site.manager
                                            }}</span>
                                        {% endif %}
                                        <span class="text-white">{{ site.url.replace('https://www.', '') }}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-white-50 font-monospace small">{{ site.consumer_key[:10] }}...</td>
                            <td class="text-white-50">
                                {% if site.last_sync %}
                                {{ site.last_sync }}
                                {% else %}
                                <span class="text-muted fst-italic">从未同步</span>
                                {% endif %}
                            </td>
                            <td>
                                <span
                                    class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">已连接</span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group me-2">
                                    <button class="btn btn-sm btn-outline-primary sync-btn" data-site-id="{{ site.id }}"
                                        title="快速同步 - 增量获取新订单"><i class="bi bi-arrow-repeat"></i></button>
                                    <button class="btn btn-sm btn-outline-info deep-sync-btn"
                                        data-site-id="{{ site.id }}" title="深度同步 - 重新获取所有订单"><i
                                            class="bi bi-cloud-download"></i></button>
                                    <button class="btn btn-sm btn-outline-warning clean-sync-btn"
                                        data-site-id="{{ site.id }}" title="清理同步 - 删除已在远程删除的订单"><i
                                            class="bi bi-trash2"></i></button>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary me-2 edit-btn"
                                    data-site-id="{{ site.id }}" data-url="{{ site.url }}"
                                    data-key="{{ site.consumer_key }}" data-secret="{{ site.consumer_secret }}"
                                    data-manager="{{ site.manager or '' }}"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-site-id="{{ site.id }}"><i
                                        class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-hdd-network display-4 d-block mb-3 opacity-50"></i>
                                暂无已连接的站点，请点击右上角添加
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Cron Settings Card -->
<div class="card data-card mb-4">
    <div class="card-header border-bottom border-secondary border-opacity-25 bg-transparent py-3">
        <h5 class="card-title text-white mb-0"><i class="bi bi-clock-history me-2"></i>定时深度同步</h5>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <p class="text-white-50 mb-2">设置每天自动执行深度同步的时间，全量拉取所有订单状态更新。</p>
                <div class="d-flex align-items-center gap-2" id="cronStatusDisplay">
                    <span class="badge bg-secondary">加载中...</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex align-items-center gap-2 justify-content-end">
                    <label class="text-white-50">每天</label>
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="cronHour"
                        style="width: 80px;">
                        <option value="0">00:00</option>
                        <option value="1">01:00</option>
                        <option value="2">02:00</option>
                        <option value="3" selected>03:00</option>
                        <option value="4">04:00</option>
                        <option value="5">05:00</option>
                        <option value="6">06:00</option>
                    </select>
                    <button class="btn btn-sm btn-success" id="setupCronBtn">
                        <i class="bi bi-check-lg me-1"></i>启用
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="removeCronBtn">
                        <i class="bi bi-x-lg me-1"></i>禁用
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clean Sync Cron Settings Card -->
<div class="card data-card mb-4">
    <div class="card-header border-bottom border-secondary border-opacity-25 bg-transparent py-3">
        <h5 class="card-title text-white mb-0"><i class="bi bi-clock-history me-2"></i>定时清理同步</h5>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <p class="text-white-50 mb-2">设置每周自动执行清理同步的时间，删除已在WooCommerce中被删除的订单。</p>
                <div class="d-flex align-items-center gap-2" id="cleanCronStatusDisplay">
                    <span class="badge bg-secondary">加载中...</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex align-items-center gap-2 justify-content-end">
                    <label class="text-white-50">每周</label>
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="cleanCronDay"
                        style="width: 80px;">
                        <option value="0">周日</option>
                        <option value="1">周一</option>
                        <option value="2">周二</option>
                        <option value="3">周三</option>
                        <option value="4">周四</option>
                        <option value="5">周五</option>
                        <option value="6">周六</option>
                    </select>
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="cleanCronHour"
                        style="width: 80px;">
                        <option value="0">00:00</option>
                        <option value="1">01:00</option>
                        <option value="2">02:00</option>
                        <option value="3">03:00</option>
                        <option value="4" selected>04:00</option>
                        <option value="5">05:00</option>
                        <option value="6">06:00</option>
                    </select>
                    <button class="btn btn-sm btn-success" id="setupCleanCronBtn">
                        <i class="bi bi-check-lg me-1"></i>启用
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="removeCleanCronBtn">
                        <i class="bi bi-x-lg me-1"></i>禁用
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exchange Rates Card -->
<div class="card data-card mb-4">
    <div
        class="card-header border-bottom border-secondary border-opacity-25 bg-transparent py-3 d-flex justify-content-between align-items-center">
        <h5 class="card-title text-white mb-0"><i class="bi bi-currency-exchange me-2"></i>汇率设置 (转换为人民币)</h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addExchangeRateModal">
            <i class="bi bi-plus-lg me-1"></i>添加汇率
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-dark table-hover align-middle mb-0" style="--bs-table-bg: transparent;">
                <thead style="position: sticky; top: 0; z-index: 1; background: #1a1d21;">
                    <tr>
                        <th class="ps-4">月份</th>
                        <th>货币</th>
                        <th>汇率 (→ CNY)</th>
                        <th>示例</th>
                        <th>更新时间</th>
                        <th class="text-end pe-4">操作</th>
                    </tr>
                </thead>
                <tbody id="exchangeRatesTableBody">
                    {% for rate in exchange_rates %}
                    <tr>
                        <td class="ps-4"><span class="badge bg-info bg-opacity-25 text-info">{{ rate.year_month
                                }}</span></td>
                        <td><span class="badge bg-warning bg-opacity-25 text-warning">{{ rate.currency }}</span>
                        </td>
                        <td class="text-white">{{ "%.4f"|format(rate.rate_to_cny) }}</td>
                        <td class="text-muted small">1 {{ rate.currency }} = ¥{{ "%.2f"|format(rate.rate_to_cny) }}
                        </td>
                        <td class="text-muted small">{{ rate.updated_at[:16] if rate.updated_at else '-' }}</td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-danger delete-rate-btn" data-rate-id="{{ rate.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-currency-exchange display-6 d-block mb-2 opacity-50"></i>
                            暂无汇率配置，请点击右上角添加
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-transparent border-top border-secondary border-opacity-25 py-2">
            <small class="text-muted">设置每月各货币对人民币的汇率。订单将按其所属月份使用对应汇率计算人民币金额。</small>
        </div>
    </div>
</div>

<!-- Add Exchange Rate Modal -->
<div class="modal fade" id="addExchangeRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="bi bi-plus-circle me-2"></i>添加汇率</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-white-50">月份 <span class="text-danger">*</span></label>
                    <input type="month" class="form-control bg-black bg-opacity-25 text-white border-secondary"
                        id="addRateYearMonth">
                    <small class="text-muted">选择汇率适用的月份</small>
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">货币代码 <span class="text-danger">*</span></label>
                    <select class="form-select bg-black bg-opacity-25 text-white border-secondary" id="addRateCurrency">
                        <option value="">选择货币</option>
                        {% for currency in currencies %}
                        <option value="{{ currency }}">{{ currency }}</option>
                        {% endfor %}
                        <option value="__custom__">自定义...</option>
                    </select>
                    <input type="text"
                        class="form-control bg-black bg-opacity-25 text-white border-secondary mt-2 d-none"
                        id="addRateCurrencyCustom" placeholder="输入货币代码，如 EUR, USD">
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">汇率 (→ CNY) <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text bg-black bg-opacity-25 text-white border-secondary">1 货币
                            =</span>
                        <input type="number" step="0.0001"
                            class="form-control bg-black bg-opacity-25 text-white border-secondary" id="addRateValue"
                            placeholder="如 1.7823">
                        <span class="input-group-text bg-black bg-opacity-25 text-white border-secondary">CNY</span>
                    </div>
                    <small class="text-muted">例如：1 PLN = 1.78 CNY，则填写 1.78</small>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveExchangeRateBtn">
                    <i class="bi bi-check-lg me-1"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Brand Management Card -->
<div class="card data-card mb-4">
    <div
        class="card-header border-bottom border-secondary border-opacity-25 bg-transparent py-3 d-flex justify-content-between align-items-center">
        <h5 class="card-title text-white mb-0"><i class="bi bi-tags me-2"></i>品牌管理</h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addBrandModal">
            <i class="bi bi-plus-lg me-1"></i>添加品牌
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-dark table-hover align-middle mb-0" style="--bs-table-bg: transparent;">
                <thead style="position: sticky; top: 0; z-index: 1; background: #1a1d21;">
                    <tr>
                        <th class="ps-4">品牌名称</th>
                        <th>别名</th>
                        <th>创建时间</th>
                        <th class="text-end pe-4">操作</th>
                    </tr>
                </thead>
                <tbody id="brandsTableBody">
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Unknown Products Card -->
<div class="card data-card mb-4">
    <div
        class="card-header border-bottom border-secondary border-opacity-25 bg-transparent py-3 d-flex justify-content-between align-items-center">
        <h5 class="card-title text-white mb-0"><i class="bi bi-question-circle me-2"></i>未识别产品</h5>
        <button class="btn btn-sm btn-outline-info" onclick="loadUnknownProducts()">
            <i class="bi bi-arrow-repeat me-1"></i>刷新
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-dark table-hover align-middle mb-0" style="--bs-table-bg: transparent;">
                <thead style="position: sticky; top: 0; z-index: 1; background: #1a1d21;">
                    <tr>
                        <th class="ps-4">产品名称</th>
                        <th class="text-center">口数</th>
                        <th class="text-end">销量</th>
                        <th class="text-end pe-4">操作</th>
                    </tr>
                </thead>
                <tbody id="unknownProductsTableBody">
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">点击刷新加载未识别产品...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-transparent border-top border-secondary border-opacity-25 py-2">
            <small class="text-muted">显示近90天内无法识别品牌的产品，按销量排序。点击"添加品牌"可快速配置。</small>
        </div>
    </div>
</div>
<div class="modal fade" id="addBrandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="bi bi-plus-circle me-2"></i>添加品牌</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-white-50">品牌名称 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-black bg-opacity-25 text-white border-secondary"
                        id="addBrandName" placeholder="如：IGET, XCOR">
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">别名（每行一个）</label>
                    <textarea class="form-control bg-black bg-opacity-25 text-white border-secondary"
                        id="addBrandAliases" rows="3" placeholder="如：&#10;iget&#10;I-GET&#10;i get"></textarea>
                    <small class="text-muted">别名用于识别不同写法的同一品牌</small>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveBrandBtn">
                    <i class="bi bi-check-lg me-1"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Brand Modal -->
<div class="modal fade" id="editBrandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="bi bi-pencil me-2"></i>编辑品牌</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editBrandId">
                <div class="mb-3">
                    <label class="form-label text-white-50">品牌名称 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-black bg-opacity-25 text-white border-secondary"
                        id="editBrandName">
                </div>
                <div class="mb-3">
                    <label class="form-label text-white-50">别名（每行一个）</label>
                    <textarea class="form-control bg-black bg-opacity-25 text-white border-secondary"
                        id="editBrandAliases" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateBrandBtn">
                    <i class="bi bi-check-lg me-1"></i>保存修改
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sync Logs Modal -->
<div class="modal fade" id="syncLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white"><i class="bi bi-journal-text me-2"></i>同步日志</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Summary Cards -->
                <div class="row mb-4" id="syncSummaryCards">
                    <!-- Cards will be populated by JavaScript -->
                </div>

                <!-- Logs Table -->
                <div class="card bg-black bg-opacity-25 border border-secondary border-opacity-25">
                    <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-white-50">最近同步记录</span>
                            <select class="form-select form-select-sm bg-dark text-white border-secondary"
                                id="logsFilterSite" style="width: 200px;">
                                <option value="">所有站点</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-dark table-hover align-middle mb-0"
                                style="--bs-table-bg: transparent;">
                                <thead>
                                    <tr>
                                        <th>站点</th>
                                        <th>时间</th>
                                        <th>状态</th>
                                        <th>新订单</th>
                                        <th>更新订单</th>
                                        <th>耗时</th>
                                        <th>消息</th>
                                    </tr>
                                </thead>
                                <tbody id="syncLogsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Site Modal -->
<div class="modal fade" id="addSiteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white">添加 WooCommerce 站点</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSiteForm">
                    <div class="mb-3">
                        <label class="form-label text-white-50">负责人</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="manager" placeholder="输入负责人姓名">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">站点 URL</label>
                        <input type="url" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="url" placeholder="https://example.com" required>
                        <div class="form-text text-muted">请输入完整的店铺网址，包含 https://</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Consumer Key</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="consumer_key" placeholder="ck_..." required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Consumer Secret</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="consumer_secret" placeholder="cs_..." required>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveSiteBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Site Modal -->
<div class="modal fade" id="editSiteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white">编辑 WooCommerce 站点</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSiteForm">
                    <input type="hidden" name="site_id" id="editSiteId">
                    <div class="mb-3">
                        <label class="form-label text-white-50">负责人</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="manager" id="editSiteManager" placeholder="输入负责人姓名">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">站点 URL</label>
                        <input type="url" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="url" id="editSiteUrl" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Consumer Key</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="consumer_key" id="editSiteKey" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Consumer Secret</label>
                        <input type="text" class="form-control bg-dark text-white border-secondary border-opacity-25"
                            name="consumer_secret" id="editSiteSecret" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="updateSiteBtn">更新</button>
            </div>
        </div>
    </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white">确认删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-white">确定要删除这个站点吗？</p>
                <p class="text-white-50 small mb-0">这将不会删除已同步的历史订单数据，但会移除站点的连接配置。</p>
                <input type="hidden" id="deleteSiteId">
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // Auto Sync Toggle and Interval
        const autoSyncToggle = document.getElementById('autoSyncToggle');
        const syncIntervalSelect = document.getElementById('syncIntervalSelect');
        const sourceDisplayToggle = document.getElementById('sourceDisplayToggle');

        if (autoSyncToggle && syncIntervalSelect) {
            // Fetch initial status
            fetch('/api/settings')
                .then(res => res.json())
                .then(data => {
                    if (data.autosync_enabled) autoSyncToggle.checked = data.autosync_enabled === 'true';
                    if (data.autosync_interval) syncIntervalSelect.value = data.autosync_interval;
                    if (sourceDisplayToggle && data.source_display_mode) {
                        sourceDisplayToggle.checked = data.source_display_mode === 'manager_only';
                    }
                });

            // Handle source display toggle
            if (sourceDisplayToggle) {
                sourceDisplayToggle.addEventListener('change', function () {
                    const mode = this.checked ? 'manager_only' : 'full';
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source_display_mode: mode })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.success) {
                                alert('设置失败');
                                this.checked = !this.checked;
                            } else {
                                // Reload to apply changes
                                location.reload();
                            }
                        })
                        .catch(err => {
                            alert('设置错误');
                            this.checked = !this.checked;
                        });
                });
            }

            // Handle toggle change
            autoSyncToggle.addEventListener('change', function () {
                const enabled = this.checked;
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autosync_enabled: enabled })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) {
                            alert('设置失败');
                            this.checked = !enabled;
                        }
                    })
                    .catch(err => {
                        alert('设置错误');
                        this.checked = !enabled;
                    });
            });

            // Handle interval change
            syncIntervalSelect.addEventListener('change', function () {
                const interval = parseInt(this.value);
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autosync_interval: interval })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) {
                            alert('设置失败');
                        }
                    })
                    .catch(err => {
                        alert('设置错误');
                    });
            });
        }

        // Sync Logs Button
        const viewSyncLogsBtn = document.getElementById('viewSyncLogsBtn');
        const syncLogsModal = document.getElementById('syncLogsModal');

        if (viewSyncLogsBtn && syncLogsModal) {
            viewSyncLogsBtn.addEventListener('click', function () {
                const modal = bootstrap.Modal.getOrCreateInstance(syncLogsModal);
                modal.show();
                loadSyncLogs();
            });

            // Filter by site
            const logsFilterSite = document.getElementById('logsFilterSite');
            if (logsFilterSite) {
                logsFilterSite.addEventListener('change', function () {
                    loadSyncLogs(this.value);
                });
            }
        }

        function loadSyncLogs(siteId = '') {
            const tableBody = document.getElementById('syncLogsTableBody');
            const summaryCards = document.getElementById('syncSummaryCards');

            // Load summary
            fetch('/api/sync/summary')
                .then(res => res.json())
                .then(summary => {
                    // Populate filter dropdown
                    const filterSelect = document.getElementById('logsFilterSite');
                    if (filterSelect && filterSelect.options.length <= 1) {
                        summary.forEach(site => {
                            const option = document.createElement('option');
                            option.value = site.site_id;
                            option.textContent = new URL(site.url).hostname;
                            filterSelect.appendChild(option);
                        });
                    }

                    // Build summary cards
                    summaryCards.innerHTML = summary.map(site => {
                        const hostname = new URL(site.url).hostname;
                        const lastSync = site.last_sync || '从未同步';
                        const stats = site.stats_7_days || {};
                        const successRate = stats.total_syncs > 0 ?
                            Math.round((stats.success_count / stats.total_syncs) * 100) : 0;
                        const statusClass = successRate >= 80 ? 'success' : successRate >= 50 ? 'warning' : 'danger';

                        return `
                            <div class="col-md-4 mb-3">
                                <div class="card bg-black bg-opacity-25 border border-secondary border-opacity-25">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="text-white mb-0">${hostname}</h6>
                                            <span class="badge bg-${statusClass} bg-opacity-10 text-${statusClass}">${successRate}%</span>
                                        </div>
                                        <small class="text-white-50 d-block">上次同步: ${lastSync}</small>
                                        <small class="text-white-50 d-block">7天内: ${stats.total_syncs || 0} 次同步</small>
                                        <small class="text-white-50 d-block">新订单: ${stats.total_new_orders || 0} | 更新: ${stats.total_updated_orders || 0}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });

            // Load logs
            const url = siteId ? `/api/sync/logs?site_id=${siteId}` : '/api/sync/logs';
            fetch(url)
                .then(res => res.json())
                .then(logs => {
                    if (logs.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">暂无同步记录</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = logs.map(log => {
                        const statusClass = log.status === 'success' ? 'success' : 'danger';
                        const hostname = log.site_url ? new URL(log.site_url).hostname : '-';
                        return `
                            <tr>
                                <td class="text-white-50">${hostname}</td>
                                <td class="text-white-50">${log.sync_time}</td>
                                <td><span class="badge bg-${statusClass} bg-opacity-10 text-${statusClass}">${log.status}</span></td>
                                <td class="text-white">${log.new_orders || 0}</td>
                                <td class="text-white">${log.updated_orders || 0}</td>
                                <td class="text-white-50">${log.duration_seconds || 0}s</td>
                                <td class="text-white-50 small" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${log.message || '-'}</td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(err => {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">加载失败</td></tr>';
                });
        }

        // Deep Sync Button
        const deepSyncBtn = document.getElementById('deepSyncBtn');
        if (deepSyncBtn) {
            deepSyncBtn.addEventListener('click', function () {
                if (!confirm('深度同步将从所有站点拉取全部订单数据，可能需要较长时间。\n\n确定要执行深度同步吗？')) {
                    return;
                }

                const modalEl = document.getElementById('syncProgressModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                const progressBar = document.getElementById('syncProgressBar');
                const statusText = document.getElementById('syncStatusText');
                const logConsole = document.getElementById('syncLogConsole');
                const closeBtn = document.getElementById('closeSyncModalBtn');
                const timeText = document.getElementById('syncTimeText');

                // Reset UI
                progressBar.style.width = '100%';
                progressBar.classList.add('progress-bar-animated', 'bg-warning');
                progressBar.classList.remove('bg-success', 'bg-danger', 'bg-primary');
                statusText.textContent = '正在启动深度同步...';
                logConsole.innerHTML = '';
                closeBtn.disabled = true;
                const startTime = Date.now();

                modal.show();

                fetch('/api/sync/deep', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const DEEP_SYNC_ID = result.sync_id;

                            const pollInterval = setInterval(() => {
                                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                                const secs = (elapsed % 60).toString().padStart(2, '0');
                                timeText.textContent = `${mins}:${secs}`;

                                fetch(`/api/sync/status/${DEEP_SYNC_ID}`)
                                    .then(res => res.json())
                                    .then(status => {
                                        statusText.textContent = status.message;

                                        if (status.logs && status.logs.length > 0) {
                                            logConsole.innerHTML = status.logs.map(log =>
                                                `<div class="text-white-50 mb-1">${log}</div>`
                                            ).join('');
                                            logConsole.scrollTop = logConsole.scrollHeight;
                                        }

                                        if (status.status === 'success') {
                                            clearInterval(pollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-warning');
                                            progressBar.classList.add('bg-success');
                                            closeBtn.disabled = false;
                                            closeBtn.textContent = '完成并刷新';
                                            // Broadcast sync completion to other tabs
                                            localStorage.setItem('syncCompleted', Date.now().toString());
                                            closeBtn.onclick = () => location.reload();
                                        } else if (status.status === 'error') {
                                            clearInterval(pollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-warning');
                                            progressBar.classList.add('bg-danger');
                                            closeBtn.disabled = false;
                                        }
                                    });
                            }, 2000);
                        }
                    });
            });
        }

        // Clean All Sites Button
        const cleanAllBtn = document.getElementById('cleanAllBtn');
        if (cleanAllBtn) {
            cleanAllBtn.addEventListener('click', function () {
                if (!confirm('清理同步将检查所有站点，删除已在WooCommerce中删除的订单。\n\n确定要执行全站点清理同步吗？')) {
                    return;
                }

                const modalEl = document.getElementById('syncProgressModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                const progressBar = document.getElementById('syncProgressBar');
                const statusText = document.getElementById('syncStatusText');
                const logConsole = document.getElementById('syncLogConsole');
                const closeBtn = document.getElementById('closeSyncModalBtn');
                const timeText = document.getElementById('syncTimeText');

                // Reset UI
                progressBar.style.width = '100%';
                progressBar.classList.add('progress-bar-animated', 'bg-danger');
                progressBar.classList.remove('bg-success', 'bg-warning', 'bg-primary');
                statusText.textContent = '正在启动全站点清理同步...';
                logConsole.innerHTML = '';
                closeBtn.disabled = true;
                const startTime = Date.now();

                modal.show();

                fetch('/api/sync/clean/all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const CLEAN_SYNC_ID = result.sync_id;

                            const pollInterval = setInterval(() => {
                                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                                const secs = (elapsed % 60).toString().padStart(2, '0');
                                timeText.textContent = `${mins}:${secs}`;

                                fetch(`/api/sync/status/${CLEAN_SYNC_ID}`)
                                    .then(res => res.json())
                                    .then(status => {
                                        statusText.textContent = status.message;

                                        if (status.logs && status.logs.length > 0) {
                                            logConsole.innerHTML = status.logs.map(log =>
                                                `<div class="text-white-50 mb-1">${log}</div>`
                                            ).join('');
                                            logConsole.scrollTop = logConsole.scrollHeight;
                                        }

                                        if (status.status === 'success') {
                                            clearInterval(pollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-danger');
                                            progressBar.classList.add('bg-success');
                                            closeBtn.disabled = false;
                                            closeBtn.textContent = '完成并刷新';
                                            localStorage.setItem('syncCompleted', Date.now().toString());
                                            closeBtn.onclick = () => location.reload();
                                        } else if (status.status === 'error') {
                                            clearInterval(pollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-danger');
                                            progressBar.classList.add('bg-danger');
                                            closeBtn.disabled = false;
                                        }
                                    });
                            }, 2000);
                        }
                    });
            });
        }

        // Cron Settings
        function loadCronStatus() {
            fetch('/api/cron/status')
                .then(res => res.json())
                .then(data => {
                    const display = document.getElementById('cronStatusDisplay');
                    if (data.enabled) {
                        display.innerHTML = `<span class="badge bg-success">已启用</span><span class="text-white-50 ms-2">执行时间: ${data.schedule}</span>`;
                    } else {
                        display.innerHTML = `<span class="badge bg-secondary">未启用</span>`;
                    }
                });
        }

        loadCronStatus();

        const setupCronBtn = document.getElementById('setupCronBtn');
        const removeCronBtn = document.getElementById('removeCronBtn');
        const cronHour = document.getElementById('cronHour');

        if (setupCronBtn) {
            setupCronBtn.addEventListener('click', function () {
                const hour = parseInt(cronHour.value);
                fetch('/api/cron/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hour: hour, minute: 0 })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            loadCronStatus();
                        } else {
                            alert('设置失败: ' + (data.error || '未知错误'));
                        }
                    });
            });
        }

        if (removeCronBtn) {
            removeCronBtn.addEventListener('click', function () {
                fetch('/api/cron/remove', { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            loadCronStatus();
                        } else {
                            alert('禁用失败: ' + (data.error || '未知错误'));
                        }
                    });
            });
        }

        // Clean Sync Cron Settings
        function loadCleanCronStatus() {
            fetch('/api/cron/clean/status')
                .then(res => res.json())
                .then(data => {
                    const display = document.getElementById('cleanCronStatusDisplay');
                    if (data.enabled) {
                        display.innerHTML = `<span class="badge bg-success">已启用</span><span class="text-white-50 ms-2">执行时间: ${data.schedule}</span>`;
                        // Set the dropdown values
                        if (document.getElementById('cleanCronDay') && data.day !== undefined) {
                            document.getElementById('cleanCronDay').value = data.day;
                        }
                        if (document.getElementById('cleanCronHour') && data.hour !== undefined) {
                            document.getElementById('cleanCronHour').value = data.hour;
                        }
                    } else {
                        display.innerHTML = `<span class="badge bg-secondary">未启用</span>`;
                    }
                });
        }

        loadCleanCronStatus();

        const setupCleanCronBtn = document.getElementById('setupCleanCronBtn');
        const removeCleanCronBtn = document.getElementById('removeCleanCronBtn');
        const cleanCronDay = document.getElementById('cleanCronDay');
        const cleanCronHour = document.getElementById('cleanCronHour');

        if (setupCleanCronBtn) {
            setupCleanCronBtn.addEventListener('click', function () {
                const day = parseInt(cleanCronDay.value);
                const hour = parseInt(cleanCronHour.value);
                fetch('/api/cron/clean/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ day: day, hour: hour, minute: 0 })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            loadCleanCronStatus();
                        } else {
                            alert('设置失败: ' + (data.error || '未知错误'));
                        }
                    });
            });
        }

        if (removeCleanCronBtn) {
            removeCleanCronBtn.addEventListener('click', function () {
                fetch('/api/cron/clean/remove', { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            loadCleanCronStatus();
                        } else {
                            alert('禁用失败: ' + (data.error || '未知错误'));
                        }
                    });
            });
        }

        // Import from Script Button
        const importBtn = document.getElementById('importFromScriptBtn');
        if (importBtn) {
            importBtn.addEventListener('click', function () {
                if (!confirm('确定要从 1.wooorders_sqlite.py 脚本中导入站点配置吗？\n\n已存在的站点将会被跳过。')) {
                    return;
                }

                importBtn.disabled = true;
                importBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> 导入中...';

                fetch('/api/sites/import-from-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(result.message);
                            location.reload();
                        } else {
                            alert('导入失败: ' + (result.error || '未知错误'));
                            importBtn.disabled = false;
                            importBtn.innerHTML = '<i class="bi bi-download me-1"></i> 从脚本导入';
                        }
                    })
                    .catch(error => {
                        alert('请求错误: ' + error);
                        importBtn.disabled = false;
                        importBtn.innerHTML = '<i class="bi bi-download me-1"></i> 从脚本导入';
                    });
            });
        }

        // Sync All Button
        const syncAllBtn = document.getElementById('syncAllBtn');
        if (syncAllBtn) {
            syncAllBtn.addEventListener('click', function () {

                const modalEl = document.getElementById('syncProgressModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                const progressBar = document.getElementById('syncProgressBar');
                const statusText = document.getElementById('syncStatusText');
                const logConsole = document.getElementById('syncLogConsole');
                const closeBtn = document.getElementById('closeSyncModalBtn');
                const timeText = document.getElementById('syncTimeText');

                // Reset UI
                progressBar.style.width = '0%';
                progressBar.classList.add('progress-bar-animated');
                progressBar.classList.remove('bg-success', 'bg-danger');
                progressBar.classList.add('bg-primary');
                statusText.textContent = '正在启动全局同步任务...';
                logConsole.innerHTML = '';
                closeBtn.disabled = true;
                const startTime = Date.now();

                modal.show();

                // Start Sync All
                fetch('/api/sync/all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const syncId = result.sync_id;

                            // Start Polling
                            const syncPollInterval = setInterval(() => {
                                // Update timer
                                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                                const secs = (elapsed % 60).toString().padStart(2, '0');
                                timeText.textContent = `${mins}:${secs}`;

                                fetch(`/api/sync/status/${syncId}`)
                                    .then(res => res.json())
                                    .then(status => {
                                        // Update Logs
                                        if (status.logs && status.logs.length > 0) {
                                            logConsole.innerHTML = status.logs.map(log =>
                                                `<div class="text-white-50 mb-1">${log}</div>`
                                            ).join('');
                                            logConsole.scrollTop = logConsole.scrollHeight;
                                        }

                                        // Update Status
                                        statusText.textContent = status.message;

                                        if (status.status === 'running') {
                                            if (progressBar.style.width === '0%') progressBar.style.width = '100%';
                                        } else if (status.status === 'success') {
                                            clearInterval(syncPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
                                            progressBar.classList.add('bg-success');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '所有站点同步完成！';
                                            statusText.classList.add('text-success');
                                            closeBtn.disabled = false;
                                            closeBtn.textContent = '完成并刷新';
                                            // Broadcast sync completion to other tabs
                                            localStorage.setItem('syncCompleted', Date.now().toString());
                                            closeBtn.onclick = () => location.reload();
                                        } else if (status.status === 'error') {
                                            clearInterval(syncPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
                                            progressBar.classList.add('bg-danger');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '同步出错';
                                            statusText.classList.add('text-danger');
                                            closeBtn.disabled = false;
                                        }
                                    });
                            }, 1000);
                        } else {
                            statusText.textContent = '启动失败: ' + result.message;
                            progressBar.classList.remove('bg-primary');
                            progressBar.classList.add('bg-danger');
                            progressBar.style.width = '100%';
                            closeBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        statusText.textContent = '请求错误: ' + error;
                        closeBtn.disabled = false;
                    });
            });
        }

        // Confirm Delete Button
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function () {
                const siteId = document.getElementById('deleteSiteId').value;
                const modalEl = document.getElementById('deleteConfirmModal');
                const modal = bootstrap.Modal.getInstance(modalEl);

                console.log('Confirmed delete for siteId:', siteId);

                // Disable button to prevent double submit
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = '删除中...';

                fetch(`/api/sites/${siteId}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(result => {
                        console.log('Delete result:', result);
                        if (result.success) {
                            location.reload();
                        } else {
                            alert('删除失败: ' + (result.error || '未知错误'));
                            confirmDeleteBtn.disabled = false;
                            confirmDeleteBtn.textContent = '确认删除';
                            if (modal) modal.hide();
                        }
                    })
                    .catch(error => {
                        console.error('Delete request error:', error);
                        alert('请求错误: ' + error);
                        confirmDeleteBtn.disabled = false;
                        confirmDeleteBtn.textContent = '确认删除';
                        if (modal) modal.hide();
                    });
            });
        }
        // Helper to safely get bootstrap modal
        function getModal(id) {
            const el = document.getElementById(id);
            if (!el) return null;
            return bootstrap.Modal.getOrCreateInstance(el);
        }

        // Add Site
        const saveBtn = document.getElementById('saveSiteBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function () {
                const form = document.getElementById('addSiteForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                fetch('/api/sites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            location.reload();
                        } else {
                            alert('添加失败: ' + (result.error || '未知错误'));
                        }
                    })
                    .catch(error => alert('发生错误: ' + error));
            });
        }

        // Update Site
        const updateBtn = document.getElementById('updateSiteBtn');
        if (updateBtn) {
            updateBtn.addEventListener('click', function () {
                const form = document.getElementById('editSiteForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                const siteId = data.site_id;

                fetch(`/api/sites/${siteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            location.reload();
                        } else {
                            alert('更新失败: ' + (result.error || '未知错误'));
                        }
                    })
                    .catch(error => alert('发生错误: ' + error));
            });
        }

        // Global Event Delegation for Dynamic Buttons
        document.body.addEventListener('click', function (e) {
            // Edit Button
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                const siteId = editBtn.dataset.siteId;
                const url = editBtn.dataset.url;
                const key = editBtn.dataset.key;
                const secret = editBtn.dataset.secret;
                const manager = editBtn.dataset.manager || '';

                document.getElementById('editSiteId').value = siteId;
                document.getElementById('editSiteUrl').value = url;
                document.getElementById('editSiteKey').value = key;
                document.getElementById('editSiteSecret').value = secret;
                document.getElementById('editSiteManager').value = manager;

                const modal = getModal('editSiteModal');
                if (modal) modal.show();
            }

            // Delete Button
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const siteId = deleteBtn.dataset.siteId;
                console.log('Delete button clicked for site:', siteId);

                document.getElementById('deleteSiteId').value = siteId;
                const modal = getModal('deleteConfirmModal');
                if (modal) modal.show();
            }

            // Sync Button
            const syncBtn = e.target.closest('.sync-btn');
            if (syncBtn) {
                const siteId = syncBtn.dataset.siteId;
                const modal = getModal('syncProgressModal');
                const progressBar = document.getElementById('syncProgressBar');
                const statusText = document.getElementById('syncStatusText');
                const logConsole = document.getElementById('syncLogConsole');
                const closeBtn = document.getElementById('closeSyncModalBtn');
                const timeText = document.getElementById('syncTimeText');

                if (!modal) return;

                // Reset UI
                progressBar.style.width = '0%';
                progressBar.classList.add('progress-bar-animated');
                progressBar.classList.remove('bg-success', 'bg-danger');
                progressBar.classList.add('bg-primary');
                statusText.textContent = '正在启动同步任务...';
                logConsole.innerHTML = '';
                closeBtn.disabled = true;
                const startTime = Date.now();

                modal.show();

                // Start Sync
                fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ site_id: siteId })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Start Polling
                            const syncPollInterval = setInterval(() => {
                                // Update timer
                                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                                const secs = (elapsed % 60).toString().padStart(2, '0');
                                timeText.textContent = `${mins}:${secs}`;

                                fetch(`/api/sync/status/${siteId}`)
                                    .then(res => res.json())
                                    .then(status => {
                                        // Update Logs
                                        if (status.logs && status.logs.length > 0) {
                                            logConsole.innerHTML = status.logs.map(log =>
                                                `<div class="text-white-50 mb-1">${log}</div>`
                                            ).join('');
                                            logConsole.scrollTop = logConsole.scrollHeight;
                                        }

                                        // Update Status
                                        statusText.textContent = status.message;

                                        if (status.status === 'running') {
                                            if (progressBar.style.width === '0%') progressBar.style.width = '100%';
                                        } else if (status.status === 'success') {
                                            clearInterval(syncPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
                                            progressBar.classList.add('bg-success');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '同步完成！';
                                            statusText.classList.add('text-success');
                                            closeBtn.disabled = false;
                                            closeBtn.textContent = '完成并刷新';
                                            // Broadcast sync completion to other tabs
                                            localStorage.setItem('syncCompleted', Date.now().toString());
                                            closeBtn.onclick = () => location.reload();
                                        } else if (status.status === 'error') {
                                            clearInterval(syncPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
                                            progressBar.classList.add('bg-danger');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '同步出错';
                                            statusText.classList.add('text-danger');
                                            closeBtn.disabled = false;
                                        }
                                    });
                            }, 1000);
                        } else {
                            statusText.textContent = '启动失败: ' + result.message;
                            progressBar.classList.remove('bg-primary');
                            progressBar.classList.add('bg-danger');
                            progressBar.style.width = '100%';
                            closeBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        statusText.textContent = '请求错误: ' + error;
                        closeBtn.disabled = false;
                    });
            }

            // Deep Sync Button (single site)
            const deepSyncBtn = e.target.closest('.deep-sync-btn');
            if (deepSyncBtn) {
                const siteId = deepSyncBtn.dataset.siteId;

                if (!confirm('深度同步将重新获取该站点的所有订单数据，可能需要较长时间。\n\n确定要执行深度同步吗？')) {
                    return;
                }

                const modal = getModal('syncProgressModal');
                const progressBar = document.getElementById('syncProgressBar');
                const statusText = document.getElementById('syncStatusText');
                const logConsole = document.getElementById('syncLogConsole');
                const closeBtn = document.getElementById('closeSyncModalBtn');
                const timeText = document.getElementById('syncTimeText');

                if (!modal) return;

                // Reset UI
                progressBar.style.width = '0%';
                progressBar.classList.add('progress-bar-animated');
                progressBar.classList.remove('bg-success', 'bg-danger', 'bg-warning');
                progressBar.classList.add('bg-info');
                statusText.textContent = '正在启动深度同步...';
                logConsole.innerHTML = '';
                closeBtn.disabled = true;
                const startTime = Date.now();

                modal.show();

                fetch(`/api/sync/deep/${siteId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const syncId = result.sync_id;
                            progressBar.style.width = '50%';

                            const deepPollInterval = setInterval(() => {
                                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                                const mins = Math.floor(elapsed / 60);
                                const secs = elapsed % 60;
                                timeText.textContent = `已用时: ${mins}分${secs}秒`;

                                fetch(`/api/sync/status/${syncId}`)
                                    .then(r => r.json())
                                    .then(status => {
                                        statusText.textContent = status.message || '深度同步中...';

                                        if (status.logs && status.logs.length > 0) {
                                            logConsole.innerHTML = status.logs.slice(-20).map(log =>
                                                `<div class="text-white-50 small">${log}</div>`
                                            ).join('');
                                            logConsole.scrollTop = logConsole.scrollHeight;
                                        }

                                        if (status.status === 'success') {
                                            clearInterval(deepPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-info');
                                            progressBar.classList.add('bg-success');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '深度同步完成！';
                                            statusText.classList.add('text-success');
                                            closeBtn.disabled = false;
                                            closeBtn.textContent = '完成并刷新';
                                            localStorage.setItem('syncCompleted', Date.now().toString());
                                            closeBtn.onclick = () => location.reload();
                                        } else if (status.status === 'error') {
                                            clearInterval(deepPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-info');
                                            progressBar.classList.add('bg-danger');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '深度同步出错';
                                            statusText.classList.add('text-danger');
                                            closeBtn.disabled = false;
                                        }
                                    });
                            }, 1000);
                        } else {
                            statusText.textContent = '启动失败: ' + result.message;
                            progressBar.classList.remove('bg-info');
                            progressBar.classList.add('bg-danger');
                            progressBar.style.width = '100%';
                            closeBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        statusText.textContent = '请求错误: ' + error;
                        closeBtn.disabled = false;
                    });
            }

            // Clean Sync Button (delete orphaned orders)
            const cleanSyncBtn = e.target.closest('.clean-sync-btn');
            if (cleanSyncBtn) {
                const siteId = cleanSyncBtn.dataset.siteId;

                if (!confirm('清理同步将删除本地数据库中已在WooCommerce远程删除的订单。\n\n确定要执行清理同步吗？')) {
                    return;
                }

                const modal = getModal('syncProgressModal');
                const progressBar = document.getElementById('syncProgressBar');
                const statusText = document.getElementById('syncStatusText');
                const logConsole = document.getElementById('syncLogConsole');
                const closeBtn = document.getElementById('closeSyncModalBtn');
                const timeText = document.getElementById('syncTimeText');

                if (!modal) return;

                // Reset UI
                progressBar.style.width = '0%';
                progressBar.classList.add('progress-bar-animated');
                progressBar.classList.remove('bg-success', 'bg-danger', 'bg-info');
                progressBar.classList.add('bg-warning');
                statusText.textContent = '正在启动清理同步...';
                logConsole.innerHTML = '';
                closeBtn.disabled = true;
                const startTime = Date.now();

                modal.show();

                fetch(`/api/sync/clean/${siteId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const syncId = result.sync_id;
                            progressBar.style.width = '50%';

                            const cleanPollInterval = setInterval(() => {
                                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                                const mins = Math.floor(elapsed / 60);
                                const secs = elapsed % 60;
                                timeText.textContent = `已用时: ${mins}分${secs}秒`;

                                fetch(`/api/sync/status/${syncId}`)
                                    .then(r => r.json())
                                    .then(status => {
                                        statusText.textContent = status.message || '清理同步中...';

                                        if (status.logs && status.logs.length > 0) {
                                            logConsole.innerHTML = status.logs.slice(-20).map(log =>
                                                `<div class="text-white-50 small">${log}</div>`
                                            ).join('');
                                            logConsole.scrollTop = logConsole.scrollHeight;
                                        }

                                        if (status.status === 'success') {
                                            clearInterval(cleanPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-warning');
                                            progressBar.classList.add('bg-success');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '清理同步完成！';
                                            statusText.classList.add('text-success');
                                            closeBtn.disabled = false;
                                            closeBtn.textContent = '完成并刷新';
                                            localStorage.setItem('syncCompleted', Date.now().toString());
                                            closeBtn.onclick = () => location.reload();
                                        } else if (status.status === 'error') {
                                            clearInterval(cleanPollInterval);
                                            progressBar.classList.remove('progress-bar-animated', 'bg-warning');
                                            progressBar.classList.add('bg-danger');
                                            progressBar.style.width = '100%';
                                            statusText.textContent = '清理同步出错';
                                            statusText.classList.add('text-danger');
                                            closeBtn.disabled = false;
                                        }
                                    });
                            }, 1000);
                        } else {
                            statusText.textContent = '启动失败: ' + result.message;
                            progressBar.classList.remove('bg-warning');
                            progressBar.classList.add('bg-danger');
                            progressBar.style.width = '100%';
                            closeBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        statusText.textContent = '请求错误: ' + error;
                        closeBtn.disabled = false;
                    });
            }
        });
    });
</script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border border-secondary border-opacity-25">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <h5 class="modal-title text-white">确认删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-white">确定要删除这个站点吗？</p>
                <p class="text-white-50 small mb-0">这将不会删除已同步的历史订单数据，但会移除站点的连接配置。</p>
                <input type="hidden" id="deleteSiteId">
            </div>
            <div class="modal-footer border-top border-secondary border-opacity-25">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- Brand Management JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Load brands on page load
        loadBrands();

        // Save brand button
        const saveBrandBtn = document.getElementById('saveBrandBtn');
        if (saveBrandBtn) {
            saveBrandBtn.addEventListener('click', function () {
                saveBrand();
            });
        }

        // Update brand button
        const updateBrandBtn = document.getElementById('updateBrandBtn');
        if (updateBrandBtn) {
            updateBrandBtn.addEventListener('click', function () {
                updateBrand();
            });
        }
    });

    function loadBrands() {
        const tbody = document.getElementById('brandsTableBody');
        if (!tbody) return;

        fetch('/api/brands')
            .then(res => res.json())
            .then(brands => {
                if (brands.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">暂无品牌数据</td></tr>';
                    return;
                }

                tbody.innerHTML = brands.map(brand => {
                    const aliasesStr = JSON.stringify(brand.aliases || []);
                    return `
                <tr>
                    <td class="ps-4">
                        <span class="badge" style="background: rgba(99, 102, 241, 0.2); color: #a5b4fc; font-size: 0.9rem;">
                            ${brand.name}
                        </span>
                    </td>
                    <td>
                        ${brand.aliases && brand.aliases.length > 0
                            ? brand.aliases.map(a => '<span class="badge bg-secondary bg-opacity-50 me-1">' + a + '</span>').join('')
                            : '<span class="text-muted">无</span>'}
                    </td>
                    <td class="text-white-50">${brand.created_at ? new Date(brand.created_at).toLocaleDateString('zh-CN') : '-'}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-info me-1" onclick="editBrand(${brand.id}, '${brand.name.replace(/'/g, "\\'")}', '${aliasesStr.replace(/'/g, "\\'")}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBrand(${brand.id}, '${brand.name.replace(/'/g, "\\'")}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
                }).join('');
            })
            .catch(err => {
                console.error('Error loading brands:', err);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">加载失败</td></tr>';
            });
    }

    function saveBrand() {
        const name = document.getElementById('addBrandName').value.trim();
        const aliasesText = document.getElementById('addBrandAliases').value.trim();

        if (!name) {
            alert('请输入品牌名称');
            return;
        }

        const aliases = aliasesText ? aliasesText.split('\n').map(a => a.trim()).filter(a => a) : [];

        fetch('/api/brands', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, aliases })
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addBrandModal')).hide();
                    document.getElementById('addBrandName').value = '';
                    document.getElementById('addBrandAliases').value = '';
                    loadBrands();
                } else {
                    alert('保存失败: ' + (result.error || '未知错误'));
                }
            })
            .catch(err => {
                alert('请求失败: ' + err);
            });
    }

    function editBrand(id, name, aliasesJson) {
        document.getElementById('editBrandId').value = id;
        document.getElementById('editBrandName').value = name;

        let aliases = [];
        try {
            aliases = JSON.parse(aliasesJson);
        } catch (e) { }

        document.getElementById('editBrandAliases').value = aliases.join('\n');

        new bootstrap.Modal(document.getElementById('editBrandModal')).show();
    }

    function updateBrand() {
        const id = document.getElementById('editBrandId').value;
        const name = document.getElementById('editBrandName').value.trim();
        const aliasesText = document.getElementById('editBrandAliases').value.trim();

        if (!name) {
            alert('请输入品牌名称');
            return;
        }

        const aliases = aliasesText ? aliasesText.split('\n').map(a => a.trim()).filter(a => a) : [];

        fetch('/api/brands/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, aliases })
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editBrandModal')).hide();
                    loadBrands();
                } else {
                    alert('更新失败: ' + (result.error || '未知错误'));
                }
            })
            .catch(err => {
                alert('请求失败: ' + err);
            });
    }

    function deleteBrand(id, name) {
        if (!confirm('确定要删除品牌 "' + name + '" 吗？')) {
            return;
        }

        fetch('/api/brands/' + id, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    loadBrands();
                } else {
                    alert('删除失败: ' + (result.error || '未知错误'));
                }
            })
            .catch(err => {
                alert('请求失败: ' + err);
            });
    }

    // Unknown Products Functions
    function loadUnknownProducts() {
        const tbody = document.getElementById('unknownProductsTableBody');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm me-2"></div>加载中...</td></tr>';

        fetch('/api/products/unknown?days=90&limit=50')
            .then(res => res.json())
            .then(products => {
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-success py-4"><i class="bi bi-check-circle me-2"></i>所有产品都已识别！</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map(product => {
                    const escapedName = product.name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    return `
                    <tr>
                        <td class="ps-4">
                            <span class="text-white">${product.name}</span>
                            <br><small class="text-muted">${product.sample_full_name.substring(0, 60)}${product.sample_full_name.length > 60 ? '...' : ''}</small>
                        </td>
                        <td class="text-center">
                            ${product.puffs ? '<span class="badge" style="background: rgba(6, 182, 212, 0.25); color: #22d3ee; border: 1px solid rgba(6, 182, 212, 0.4);">' + product.puffs + '</span>' : '<span class="text-muted">-</span>'}
                        </td>
                        <td class="text-end"><strong>${product.quantity}</strong></td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-primary" onclick="addBrandFromUnknown('${escapedName}')">
                                <i class="bi bi-plus-lg me-1"></i>添加品牌
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            })
            .catch(err => {
                console.error('Error loading unknown products:', err);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">加载失败</td></tr>';
            });
    }

    function addBrandFromUnknown(productName) {
        // Try to extract a brand name from the product name
        // Usually the first 1-2 words before the puff count
        let suggestedBrand = productName;

        // Remove puff count and everything after
        const puffMatch = productName.match(/(\d+)\s*puffs?/i);
        if (puffMatch) {
            suggestedBrand = productName.substring(0, productName.toLowerCase().indexOf(puffMatch[0])).trim();
        }

        // Clean up common suffixes
        suggestedBrand = suggestedBrand.replace(/\s+(disposable|vape|pod|bar).*$/i, '').trim();

        // Pre-fill the add brand form
        document.getElementById('addBrandName').value = suggestedBrand;
        document.getElementById('addBrandAliases').value = productName;

        // Show the modal
        new bootstrap.Modal(document.getElementById('addBrandModal')).show();
    }

    // Exchange Rate Management
    const addRateCurrency = document.getElementById('addRateCurrency');
    const addRateCurrencyCustom = document.getElementById('addRateCurrencyCustom');

    if (addRateCurrency) {
        addRateCurrency.addEventListener('change', function () {
            if (this.value === '__custom__') {
                addRateCurrencyCustom.classList.remove('d-none');
            } else {
                addRateCurrencyCustom.classList.add('d-none');
            }
        });
    }

    const saveExchangeRateBtn = document.getElementById('saveExchangeRateBtn');
    if (saveExchangeRateBtn) {
        saveExchangeRateBtn.addEventListener('click', function () {
            const yearMonth = document.getElementById('addRateYearMonth').value;
            let currency = document.getElementById('addRateCurrency').value;
            const rateValue = document.getElementById('addRateValue').value;

            if (currency === '__custom__') {
                currency = document.getElementById('addRateCurrencyCustom').value.toUpperCase();
            }

            if (!yearMonth || !currency || !rateValue) {
                alert('请填写所有字段');
                return;
            }

            fetch('/api/exchange-rates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    year_month: yearMonth,
                    currency: currency,
                    rate_to_cny: parseFloat(rateValue)
                })
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        alert('汇率保存成功');
                        location.reload();
                    } else {
                        alert('保存失败: ' + (result.error || '未知错误'));
                    }
                })
                .catch(err => {
                    alert('请求失败: ' + err);
                });
        });
    }

    // Delete exchange rate
    document.querySelectorAll('.delete-rate-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (!confirm('确定要删除这个汇率吗？')) return;

            const rateId = this.dataset.rateId;
            fetch('/api/exchange-rates/' + rateId, { method: 'DELETE' })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('删除失败: ' + (result.error || '未知错误'));
                    }
                });
        });
    });
</script>

{% endblock %}