{% extends "base.html" %}

{% block title %}月度统计 - 苍赋管理系统{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="text-light mb-0">
            <i class="bi bi-calendar3 me-2"></i>月度统计分析
            {% if source_filter %}<small class="text-muted ms-2">({{ source_filter.replace('https://www.',
                '').replace('https://', '')
                }})</small>{% endif %}
        </h5>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary"><i class="bi bi-sort-alpha-down me-1"></i>排序：</span>
                <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('monthly', source=source_filter, sort='month') }}"
                        class="btn {% if sort_by == 'month' or not sort_by %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                        按月份
                    </a>
                    <a href="{{ url_for('monthly', source=source_filter, sort='source') }}"
                        class="btn {% if sort_by == 'source' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                        按网站
                    </a>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary"><i class="bi bi-person-badge me-1"></i>负责人：</span>
                <select id="managerFilter" class="form-select form-select-sm" style="width: auto; min-width: 120px;"
                    onchange="window.location.href='{{ url_for('monthly', sort=sort_by) }}&manager=' + this.value">
                    <option value="">全部负责人</option>
                    {% for manager in all_managers %}
                    <option value="{{ manager }}" {% if manager_filter==manager %}selected{% endif %}>
                        {{ manager }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary"><i class="bi bi-globe me-1"></i>网站：</span>
                <select id="sourceFilter" class="form-select form-select-sm" style="width: auto; min-width: 180px;"
                    onchange="window.location.href='{{ url_for('monthly', sort=sort_by) }}&source=' + this.value">
                    <option value="">全部网站</option>
                    {% for source in sources %}
                    <option value="{{ source.source }}" {% if source_filter==source.source %}selected{% endif %}>
                        {{ source.source.replace('https://www.', '').replace('https://', '') }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Monthly Stats Table -->
    <div class="card data-card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 monthly-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="align-middle">月份</th>
                            <th rowspan="2" class="align-middle">网站</th>
                            <th rowspan="2" class="align-middle text-center">货币</th>
                            <th colspan="3" class="text-center border-start">总计</th>
                            <th colspan="4" class="text-center border-start">成功订单</th>
                            <th colspan="2" class="text-center border-start">失败/取消</th>
                            <th rowspan="2" class="align-middle text-center">汇率</th>
                            <th rowspan="2" class="align-middle text-end text-warning">¥净金额</th>
                        </tr>
                        <tr>
                            <th class="text-end border-start">订单数</th>
                            <th class="text-end">产品数</th>
                            <th class="text-end">金额</th>
                            <th class="text-end border-start">订单数</th>
                            <th class="text-end">产品数</th>
                            <th class="text-end">金额</th>
                            <th class="text-end">净金额</th>
                            <th class="text-end border-start">失败</th>
                            <th class="text-end">取消</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set current_month = namespace(value=None) %}
                        {% for row in monthly_stats %}
                        {% if (sort_by == 'month' or not sort_by) and row.month != current_month.value %}
                        {% set current_month.value = row.month %}
                        <tr class="table-active border-bottom border-secondary"
                            style="--bs-table-bg-type: rgba(255,255,255,0.05);">
                            <td colspan="3" class="align-middle ps-3">
                                <span class="badge bg-primary bg-opacity-50 text-light fs-6">{{ row.month }} 月度汇总</span>
                            </td>
                            <td class="text-end fw-bold align-middle text-light border-start">{{
                                "{:,}".format(monthly_aggregates[row.month].total_orders) }}</td>
                            <td class="text-end fw-bold align-middle text-light">{{
                                "{:,}".format(monthly_aggregates[row.month].total_products) }}</td>
                            <td class="text-end"></td>
                            <td class="text-end text-success fw-bold align-middle border-start">{{
                                "{:,}".format(monthly_aggregates[row.month].success_orders) }}</td>
                            <td class="text-end text-info fw-bold align-middle">{{
                                "{:,}".format(monthly_aggregates[row.month].success_products) }}</td>
                            <td colspan="2"></td>
                            <td class="text-end text-danger fw-bold align-middle border-start">{{
                                "{:,}".format(monthly_aggregates[row.month].failed_orders) }}</td>
                            <td class="text-end text-danger fw-bold align-middle">{{
                                "{:,}".format(monthly_aggregates[row.month].cancelled_orders) }}</td>
                            <td colspan="1"></td>
                            <td class="text-end text-warning fw-bold align-middle fs-6">¥{{
                                "{:,.2f}".format(monthly_aggregates[row.month].success_net_amount_cny) }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td><strong>{{ row.month }}</strong></td>
                            <td>{% set mgr = site_managers.get(row.source, '') %}{% if mgr %}<span class="badge me-1"
                                    style="background:rgba(23,162,184,0.3);color:#17a2b8;">{{ mgr }}</span>{% endif
                                %}{% if source_display_mode != 'manager_only' %}<span class="source-badge">{{
                                    row.source.replace('https://www.', '').replace('https://', '') }}</span>{% endif %}
                            </td>
                            <td class="text-center"><span class="badge bg-secondary">{{ row.currency or 'N/A' }}</span>
                            </td>
                            <td class="text-end border-start">{{ "{:,}".format(row.total_orders) }}</td>
                            <td class="text-end">{{ "{:,}".format(row.total_products) }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(row.total_amount) }} {{ row.currency or '' }}</td>
                            <td class="text-end border-start text-success">{{ "{:,}".format(row.success_orders) }}</td>
                            <td class="text-end text-success">{{ "{:,}".format(row.success_products) }}</td>
                            <td class="text-end text-success">{{ "{:,.2f}".format(row.success_amount) }} {{ row.currency
                                or '' }}</td>
                            <td class="text-end text-success">{{ "{:,.2f}".format(row.success_net_amount) }} {{
                                row.currency or '' }}</td>
                            <td class="text-end border-start text-danger">{{ row.failed_orders }}</td>
                            <td class="text-end text-danger">{{ row.cancelled_orders }}</td>
                            <td class="text-center"><span class="badge bg-info bg-opacity-25 text-info">{{
                                    "%.4f"|format(row.rate_to_cny) if row.rate_to_cny else '-' }}</span></td>
                            <td class="text-end text-warning">{% if row.success_net_amount_cny %}¥{{
                                "{:,.2f}".format(row.success_net_amount_cny) }}{% else %}-{% endif %}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="14" class="text-center py-5">
                                <i class="bi bi-inbox display-4 text-muted"></i>
                                <p class="text-muted mt-3">暂无统计数据</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Monthly Chart -->
    {% if monthly_stats %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card chart-card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart-line me-2"></i>月度趋势对比</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyCompareChart" height="350"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if monthly_stats %}
<script>
    var monthlyStats = {{ monthly_stats | tojson | safe }};
    var sources = [...new Set(monthlyStats.map(function (d) { return d.source; }))];

    // Build source to currency mapping
    var sourceCurrencyMap = {};
    monthlyStats.forEach(function (d) {
        if (d.source && d.currency) {
            sourceCurrencyMap[d.source] = d.currency;
        }
    });

    // Process data for chart
    var months = [...new Set(monthlyStats.map(function (d) { return d.month; }))].sort();
    var sourceColors = {
        'https://www.buchmistrz.pl': { bg: 'rgba(102, 126, 234, 0.8)', border: '#667eea' },
        'https://www.strefajednorazowek.pl': { bg: 'rgba(240, 147, 251, 0.8)', border: '#f093fb' }
    };

    var datasets = sources.map(function (source, idx) {
        var defaultColor = 'hsl(' + (idx * 137) + ', 70%, 60%)';
        var colors = sourceColors[source] || { bg: defaultColor, border: defaultColor };
        var currency = sourceCurrencyMap[source] || 'PLN';

        return {
            label: source.replace('https://www.', '').replace('https://', ''),
            data: months.map(function (month) {
                var entry = monthlyStats.find(function (d) { return d.month === month && d.source === source; });
                return entry ? entry.success_net_amount : 0;
            }),
            backgroundColor: colors.bg,
            borderColor: colors.border,
            borderWidth: 2,
            borderRadius: 6,
            currency: currency  // Store currency for tooltip
        };
    });

    var ctx = document.getElementById('monthlyCompareChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: {
                    labels: { color: '#fff', padding: 20 }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            var currency = context.dataset.currency || 'PLN';
                            return context.dataset.label + ': ' + context.raw.toLocaleString('zh-CN', { minimumFractionDigits: 2 }) + ' ' + currency;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#aaa' }
                },
                y: {
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: {
                        color: '#aaa',
                        callback: function (value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}