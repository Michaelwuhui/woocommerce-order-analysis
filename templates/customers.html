{% extends "base.html" %}

{% block title %}客户分析 - WooCommerce 订单分析{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <div>
            <h1 class="h2 text-white">客户分析</h1>
            <p class="text-muted">深入了解您的客户群体，发现高价值客户并采取行动。</p>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0 gap-3">
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary"><i class="bi bi-globe me-1"></i>网站：</span>
                <select id="sourceFilter" class="form-select form-select-sm bg-dark text-white border-secondary"
                    style="width: auto; min-width: 180px;"
                    onchange="window.location.href='{{ url_for('customers') }}?source=' + this.value">
                    <option value="">全部网站</option>
                    {% for source in sources %}
                    <option value="{{ source.source }}" {% if source_filter==source.source %}selected{% endif %}>
                        {{ source.source.replace('https://www.', '') }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary">导出 Excel</button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card data-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">客户总数</h6>
                        <div class="icon-box bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                    <h3 class="mb-1 text-white">{{ stats.total_customers }}</h3>
                    <p class="mb-0 text-muted small">
                        <span class="text-success"><i class="bi bi-arrow-up-short"></i> {{
                            stats.new_customer_rate|round(1) }}%</span> 本月新增
                    </p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card data-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">平均客单价 (LTV)</h6>
                        <div class="icon-box bg-success bg-opacity-10 text-success">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                    </div>
                    <h3 class="mb-1 text-white">{{ stats.avg_ltv|round(2) }} <span class="fs-6">PLN</span></h3>
                    <p class="mb-0 text-muted small">历史平均消费总额</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card data-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">复购率</h6>
                        <div class="icon-box bg-info bg-opacity-10 text-info">
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                    </div>
                    <h3 class="mb-1 text-white">{{ stats.repeat_rate|round(1) }}%</h3>
                    <p class="mb-0 text-muted small">购买超过 1 次的客户占比</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card data-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-muted mb-0">VIP 客户占比</h6>
                        <div class="icon-box bg-warning bg-opacity-10 text-warning">
                            <i class="bi bi-star-fill"></i>
                        </div>
                    </div>
                    <h3 class="mb-1 text-white">{{ (stats.tier_counts.VIP / stats.total_customers * 100)|round(1) if
                        stats.total_customers > 0 else 0 }}%</h3>
                    <p class="mb-0 text-muted small">{{ stats.tier_counts.VIP }} 位 VIP 客户</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card data-card h-100">
                <div class="card-header">
                    <h5><i class="bi bi-pie-chart me-2"></i>客户等级分布</h5>
                </div>
                <div class="card-body">
                    <canvas id="customerTierChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card data-card h-100">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart me-2"></i>Top 10 高价值客户</h5>
                </div>
                <div class="card-body">
                    <canvas id="topCustomersChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Customers Table -->
    <div class="card data-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-list-ul me-2"></i>客户列表</h5>
            <!-- Search input removed as DataTables handles it -->
        </div>
        <div class="card-body p-0">
            <div class="table-responsive p-3">
                <table class="table table-dark table-hover mb-0 align-middle" id="customersTable">
                    <thead>
                        <tr>
                            <th>客户姓名</th>
                            <th>来源</th>
                            <th>触达通道</th>
                            <th>等级</th>
                            <th class="text-center">订单数</th>
                            <th class="text-end">总消费 (PLN)</th>
                            <th>最近购买</th>
                            <th>建议行动 (Smart Actions)</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in customers %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div
                                        class="avatar-circle me-2 bg-gradient-{{ 'warning' if c.tier == 'VIP' else ('success' if c.tier == '优质' else ('primary' if c.tier == '普通' else 'secondary')) }}">
                                        {{ c.name[0]|upper if c.name else '?' }}
                                    </div>
                                    <div>
                                        <div class="fw-bold text-white">{{ c.name or 'Unknown' }}</div>
                                        <small class="text-muted">{{ c.email }}</small>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge bg-dark border border-secondary">{{ c.source }}</span></td>
                            <td>
                                <div class="btn-group">
                                    <a href="mailto:{{ c.email }}" class="btn btn-sm btn-outline-secondary"
                                        title="发送邮件"><i class="bi bi-envelope"></i></a>
                                    {% if c.phone %}
                                    <a href="tel:{{ c.phone }}" class="btn btn-sm btn-outline-secondary" title="拨打电话"><i
                                            class="bi bi-telephone"></i></a>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if c.tier == 'VIP' %}
                                <span class="badge bg-warning text-dark"><i class="bi bi-star-fill me-1"></i>VIP</span>
                                {% elif c.tier == '优质' %}
                                <span class="badge bg-success"><i class="bi bi-gem me-1"></i>优质</span>
                                {% elif c.tier == '普通' %}
                                <span class="badge bg-primary"><i class="bi bi-person-check me-1"></i>普通</span>
                                {% else %}
                                <span class="badge bg-secondary"><i class="bi bi-person me-1"></i>新客</span>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ c.successful_orders }}</td>
                            <td class="text-end fw-bold text-success">{{ c.total_spent|round(2) }}</td>
                            <td>{{ c.last_order_date|replace('T', ' ')|truncate(11, True, '') }}</td>
                            <td>
                                {% for action in c.actions %}
                                <span
                                    class="badge rounded-pill bg-{{ action.type }} bg-opacity-25 text-{{ action.type }} border border-{{ action.type }} me-1 mb-1"
                                    title="{{ action.text }}">
                                    <i class="bi bi-{{ action.icon }} me-1"></i>{{ action.text }}
                                </span>
                                {% endfor %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info"
                                    onclick="showCustomerDetail('{{ c.email }}')">详情</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<style>
    /* DataTables Dark Mode Overrides */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .dataTables_wrapper .dataTables_paginate {
        color: #94a3b8 !important;
        margin-bottom: 1rem;
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        background-color: #1f2937 !important;
        border: 1px solid #374151 !important;
        color: #fff !important;
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
    }

    .dataTables_wrapper .dataTables_filter input:focus {
        outline: none;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
    }

    .page-item.disabled .page-link {
        background-color: #1f2937;
        border-color: #374151;
        color: #6b7280;
    }

    .page-item.active .page-link {
        background-color: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .page-link {
        background-color: #1f2937;
        border-color: #374151;
        color: #94a3b8;
    }

    .page-link:hover {
        background-color: #374151;
        color: #fff;
    }

    div.dataTables_wrapper div.dataTables_filter {
        text-align: right;
    }
</style>

<script>
    $(document).ready(function () {
        $('#customersTable').DataTable({
            language: {
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 项结果",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            order: [[5, 'desc']], // Default sort by Total Spent (index 5)
            columnDefs: [
                { orderable: false, targets: [2, 7, 8] } // Disable sort for Contact, Smart Actions, Actions
            ],
            pageLength: 25
        });
    });

    // Tier Chart
    var ctxTier = document.getElementById('customerTierChart').getContext('2d');
    new Chart(ctxTier, {
        type: 'doughnut',
        data: {
            labels: ['VIP', '优质', '普通', '新客'],
            datasets: [{
                data: [{{ stats.tier_counts.VIP }}, {{ stats.tier_counts['优质'] }}, {{ stats.tier_counts['普通'] }}, {{ stats.tier_counts['新客'] }}],
        backgroundColor: ['#f59e0b', '#10b981', '#3b82f6', '#6b7280'],
        borderWidth: 0
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: { color: '#94a3b8' }
            }
        }
    }
    });

    // Top Customers Chart
    var ctxTop = document.getElementById('topCustomersChart').getContext('2d');
    var topCustomers = {{ customers[:10] | tojson }};
    new Chart(ctxTop, {
        type: 'bar',
        data: {
            labels: topCustomers.map(c => c.name || c.email),
            datasets: [{
                label: '总消费 (PLN)',
                data: topCustomers.map(c => c.total_spent),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
</script>
{% endblock %}