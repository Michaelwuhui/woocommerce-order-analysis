{% extends "base.html" %}

{% block title %}é—®é¢˜åˆ†æ - è‹èµ‹ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="text-light mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>è®¢å•é—®é¢˜åˆ†æ
            {% if source_filter %}<small class="text-muted ms-2">({{ source_filter.replace('https://www.',
                '').replace('https://', '') }})</small>{% endif %}
        </h5>
    </div>

    <!-- Quick Filters -->
    <div class="quick-filters mb-4">
        <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="text-secondary me-2"><i class="bi bi-calendar-range me-1"></i>å¿«é€Ÿç­›é€‰ï¼š</span>
                <a href="{{ url_for('cancelled_analysis', quick_date='this_month', source=source_filter, manager=manager_filter) }}"
                    class="btn btn-quick {% if quick_date == 'this_month' %}active{% endif %}">æœ¬æœˆè‡³ä»Š</a>
                <a href="{{ url_for('cancelled_analysis', quick_date='last_month', source=source_filter, manager=manager_filter) }}"
                    class="btn btn-quick {% if quick_date == 'last_month' %}active{% endif %}">ä¸Šä¸ªæœˆ</a>
                <a href="{{ url_for('cancelled_analysis', quick_date='last_quarter', source=source_filter, manager=manager_filter) }}"
                    class="btn btn-quick {% if quick_date == 'last_quarter' %}active{% endif %}">è¿‘ä¸‰ä¸ªæœˆ</a>
                <a href="{{ url_for('cancelled_analysis', quick_date='half_year', source=source_filter, manager=manager_filter) }}"
                    class="btn btn-quick {% if quick_date == 'half_year' %}active{% endif %}">è¿‘åŠå¹´</a>
                <a href="{{ url_for('cancelled_analysis', quick_date='one_year', source=source_filter, manager=manager_filter) }}"
                    class="btn btn-quick {% if quick_date == 'one_year' %}active{% endif %}">è¿‘ä¸€å¹´</a>
                <a href="{{ url_for('cancelled_analysis', quick_date='all', source=source_filter, manager=manager_filter) }}"
                    class="btn btn-outline-secondary btn-sm {% if quick_date == 'all' %}active{% endif %}">å…¨éƒ¨</a>
            </div>
            <div class="d-flex align-items-center gap-3">
                <!-- Month Filter -->
                <div class="d-flex align-items-center gap-2">
                    <span class="text-secondary"><i class="bi bi-calendar3 me-1"></i>æœˆä»½ï¼š</span>
                    <select id="monthFilter" class="form-select form-select-sm" style="width: auto; min-width: 120px;"
                        onchange="applyFilters()">
                        <option value="">å…¨éƒ¨</option>
                        {% for month in available_months %}
                        <option value="{{ month }}" {% if current_month==month %}selected{% endif %}>{{ month }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Manager Filter -->
                <div class="d-flex align-items-center gap-2">
                    <span class="text-secondary"><i class="bi bi-person-badge me-1"></i>è´Ÿè´£äººï¼š</span>
                    <select id="managerFilter" class="form-select form-select-sm" style="width: auto; min-width: 120px;"
                        onchange="applyFilters()">
                        <option value="">å…¨éƒ¨è´Ÿè´£äºº</option>
                        {% for manager in all_managers %}
                        <option value="{{ manager }}" {% if manager_filter==manager %}selected{% endif %}>{{ manager }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Source Filter -->
                <div class="d-flex align-items-center gap-2">
                    <span class="text-secondary"><i class="bi bi-globe me-1"></i>ç½‘ç«™ï¼š</span>
                    <select id="sourceFilter" class="form-select form-select-sm" style="width: auto; min-width: 180px;"
                        onchange="applyFilters()">
                        <option value="">å…¨éƒ¨ç½‘ç«™</option>
                        {% for source in sources %}
                        <option value="{{ source.source }}" {% if source_filter==source.source %}selected{% endif %}>
                            {{ source.source.replace('https://www.', '').replace('https://', '') }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stat-card h-100 stat-card-danger">
                <div class="stat-icon">
                    <i class="bi bi-x-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_cancelled }}</h3>
                    <p>é—®é¢˜è®¢å•æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card h-100 stat-card-success">
                <div class="stat-icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-content text-end">
                    {% for cs in currency_stats[:3] %}
                    <div>
                        {{ "{:,.2f}".format(cs.amount) }} {{ cs.currency }}
                    </div>
                    {% endfor %}
                    {% if currency_stats|length > 3 %}
                    <small>+{{ currency_stats|length - 3 }} ç§è´§å¸...</small>
                    {% endif %}
                    <div class="mt-2">
                        <span class="badge bg-warning text-dark">â‰ˆ Â¥{{ "{:,.2f}".format(total_cny) }}</span>
                    </div>
                    <p class="mb-0 mt-1">é—®é¢˜è®¢å•é‡‘é¢</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card h-100 stat-card-info">
                <div class="stat-icon">
                    <i class="bi bi-percent"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ cancellation_rate }}%</h3>
                    <p>å–æ¶ˆ/å¤±è´¥ç‡</p>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card h-100 stat-card-warning">
                <div class="stat-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ timing_stats.over_7_days.count }}</h3>
                    <p>7å¤©+æœªå¤„ç†å–æ¶ˆ <small class="text-secondary">(è¿è¥é—®é¢˜)</small></p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Timing Analysis -->
        <div class="col-xl-4">
            <div class="card data-card h-100">
                <div class="card-header">
                    <h6 class="mb-0 text-light"><i class="bi bi-hourglass-split me-2"></i>æŒ‰å–æ¶ˆæ—¶æœºåˆ†æ</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-success"><i class="bi bi-check-circle me-1"></i>1å¤©å†…å–æ¶ˆ</span>
                            <span class="badge bg-success">{{ timing_stats.within_1_day.count }} å•</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success"
                                style="width: {{ (timing_stats.within_1_day.count / total_cancelled * 100) if total_cancelled > 0 else 0 }}%">
                            </div>
                        </div>
                        <small class="text-secondary">é‡‘é¢: {{ "{:,.2f}".format(timing_stats.within_1_day.amount)
                            }}</small>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>1-7å¤©å–æ¶ˆ</span>
                            <span class="badge bg-warning text-dark">{{ timing_stats['1_to_7_days'].count }} å•</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning"
                                style="width: {{ (timing_stats['1_to_7_days'].count / total_cancelled * 100) if total_cancelled > 0 else 0 }}%">
                            </div>
                        </div>
                        <small class="text-secondary">é‡‘é¢: {{ "{:,.2f}".format(timing_stats['1_to_7_days'].amount)
                            }}</small>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-danger"><i class="bi bi-x-octagon me-1"></i>7å¤©+å–æ¶ˆ</span>
                            <span class="badge bg-danger">{{ timing_stats.over_7_days.count }} å•</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger"
                                style="width: {{ (timing_stats.over_7_days.count / total_cancelled * 100) if total_cancelled > 0 else 0 }}%">
                            </div>
                        </div>
                        <small class="text-secondary">é‡‘é¢: {{ "{:,.2f}".format(timing_stats.over_7_days.amount) }} <span
                                class="text-danger">(å¯èƒ½æ˜¯è¿è¥é—®é¢˜)</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status & Customer Type -->
        <div class="col-xl-4">
            <div class="card data-card h-100">
                <div class="card-header">
                    <h6 class="mb-0 text-light"><i class="bi bi-pie-chart me-2"></i>æŒ‰ç±»å‹åˆ†æ</h6>
                </div>
                <div class="card-body">
                    <h6 class="text-light mb-3">è®¢å•çŠ¶æ€</h6>
                    <div class="d-flex gap-3 mb-4">
                        <div class="flex-fill text-center p-3 rounded" style="background: rgba(239, 68, 68, 0.2);">
                            <div class="h4 text-danger mb-1">{{ status_stats.cancelled.count }}</div>
                            <small class="text-secondary">å·²å–æ¶ˆ</small>
                        </div>
                        <div class="flex-fill text-center p-3 rounded" style="background: rgba(220, 38, 38, 0.2);">
                            <div class="h4 text-danger mb-1">{{ status_stats.failed.count }}</div>
                            <small class="text-secondary">å¤±è´¥</small>
                        </div>
                    </div>

                    <h6 class="text-light mb-3">å®¢æˆ·ç±»å‹</h6>
                    <div class="d-flex gap-3">
                        <div class="flex-fill text-center p-3 rounded" style="background: rgba(59, 130, 246, 0.2);">
                            <div class="h4 text-info mb-1">{{ customer_type_stats.new.count }}</div>
                            <small class="text-secondary">æ–°å®¢å–æ¶ˆ</small>
                        </div>
                        <div class="flex-fill text-center p-3 rounded" style="background: rgba(249, 115, 22, 0.2);">
                            <div class="h4 text-warning mb-1">{{ customer_type_stats.repeat.count }}</div>
                            <small class="text-secondary">è€å®¢å–æ¶ˆ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- By Source -->
        <div class="col-xl-4">
            <div class="card data-card h-100">
                <div class="card-header">
                    <h6 class="mb-0 text-light"><i class="bi bi-globe me-2"></i>æŒ‰ç½‘ç«™åˆ†æ</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ç½‘ç«™</th>
                                    <th class="text-center">å–æ¶ˆ</th>
                                    <th class="text-center">å¤±è´¥</th>
                                    <th class="text-end">é‡‘é¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in source_stats %}
                                <tr>
                                    <td>
                                        {% if stat.manager %}<span class="badge me-1"
                                            style="background:rgba(23,162,184,0.3);color:#17a2b8;">{{ stat.manager
                                            }}</span>{% endif %}
                                        {% if source_display_mode != 'manager_only' %}
                                        <span class="small">{{ stat.source.replace('https://www.',
                                            '').replace('https://', '') }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center text-danger">{{ stat.cancelled }}</td>
                                    <td class="text-center text-danger">{{ stat.failed }}</td>
                                    <td class="text-end">{{ "{:,.2f}".format(stat.amount) }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Problem Orders List -->
    <div class="card data-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0 text-light"><i class="bi bi-list-ul me-2"></i>é—®é¢˜è®¢å•åˆ—è¡¨
                <span class="badge bg-primary ms-2">{{ orders|length }} æ¡</span>
                {% if current_month %}<span class="badge bg-info ms-1">{{ current_month }}</span>{% endif %}
            </h6>
            <a href="{{ url_for('orders', status='cancelled', month='all') }}" class="btn btn-sm btn-outline-info">
                <i class="bi bi-box-arrow-up-right me-1"></i>åœ¨è®¢å•é¡µæŸ¥çœ‹
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                    <thead>
                        <tr>
                            <th>è®¢å•å·</th>
                            <th>çŠ¶æ€</th>
                            <th>å–æ¶ˆæ—¶æœº</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>å–æ¶ˆç”¨æ—¶</th>
                            <th>å®¢æˆ·</th>
                            <th>å®¢æˆ·ç±»å‹</th>
                            <th>ç½‘ç«™</th>
                            <th class="text-center">å•†å“æ•°</th>
                            <th class="text-end">é‡‘é¢</th>
                            <th class="text-center">æ±‡ç‡</th>
                            <th class="text-end">Â¥æ€»é¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>
                                <a href="javascript:void(0)" onclick="showOrderDetail('{{ order.id }}')"
                                    class="text-info text-decoration-none">
                                    #{{ order.number }}
                                </a>
                            </td>
                            <td>
                                {% if order.status == 'cancelled' %}
                                <span class="badge bg-danger bg-opacity-25 text-danger">å·²å–æ¶ˆ</span>
                                {% else %}
                                <span class="badge bg-danger">å¤±è´¥</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if order.timing_category == '1å¤©å†…' %}
                                <span class="badge bg-success bg-opacity-25 text-success">{{ order.timing_category
                                    }}</span>
                                {% elif order.timing_category == '1-7å¤©' %}
                                <span class="badge bg-warning bg-opacity-25 text-warning">{{ order.timing_category
                                    }}</span>
                                {% else %}
                                <span class="badge bg-danger bg-opacity-25 text-danger">{{ order.timing_category
                                    }}</span>
                                {% endif %}
                            </td>
                            <td class="text-secondary small">{{ order.date_created[:16].replace('T', ' ') if
                                order.date_created else '-' }}</td>
                            <td>
                                <span
                                    class="{% if order.days_to_cancel > 7 %}text-danger{% elif order.days_to_cancel > 1 %}text-warning{% else %}text-success{% endif %}">
                                    {{ order.days_to_cancel }} å¤©
                                </span>
                            </td>
                            <td>
                                <a href="javascript:void(0)" onclick="showCustomerDetail('{{ order.customer_email }}')"
                                    class="text-info text-decoration-none text-truncate d-inline-block"
                                    style="max-width: 120px;" title="{{ order.customer_name }}">
                                    {{ order.customer_name or '-' }}
                                </a>
                            </td>
                            <td>
                                {% if order.customer_type == 'æ–°å®¢' %}
                                <span class="badge bg-info bg-opacity-25 text-info">æ–°å®¢</span>
                                {% elif order.customer_type == 'è€å®¢' %}
                                <span class="badge bg-warning bg-opacity-25 text-warning">è€å®¢</span>
                                {% else %}
                                <span class="badge bg-secondary bg-opacity-25 text-secondary">æœªçŸ¥</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set mgr = site_managers.get(order.source, '') %}
                                {% if mgr %}<span class="badge me-1"
                                    style="background:rgba(23,162,184,0.3);color:#17a2b8;">{{ mgr }}</span>{% endif %}
                                {% if source_display_mode != 'manager_only' %}
                                <span class="small text-secondary">{{ order.source.replace('https://www.',
                                    '').replace('https://', '') }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ order.product_count }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(order.total|float) }} {{ order.currency }}</td>
                            <td class="text-center"><span class="badge bg-info bg-opacity-25 text-info small">{{
                                    "%.4f"|format(order.rate_to_cny) if order.rate_to_cny else '-' }}</span></td>
                            <td class="text-end text-warning">{% if order.total_cny %}Â¥{{
                                "{:,.2f}".format(order.total_cny) }}{% else %}-{% endif %}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="13" class="text-center py-5">
                                <i class="bi bi-check-circle display-4 text-success"></i>
                                <p class="text-secondary mt-3">æœ¬æœŸæ²¡æœ‰é—®é¢˜è®¢å• ğŸ‰</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Monthly Pagination -->
    {% if available_months|length > 0 %}
    <div class="mt-4">
        <div class="d-flex justify-content-center align-items-center flex-wrap gap-2">
            <span class="text-secondary me-2"><i class="bi bi-calendar3 me-1"></i>é€‰æ‹©æœˆä»½ï¼š</span>
            {% for month in available_months %}
            <a href="{{ url_for('cancelled_analysis', month=month, source=source_filter, manager=manager_filter) }}"
                class="btn btn-month {% if month == current_month %}active{% endif %}">
                {{ month }}
            </a>
            {% endfor %}
            <a href="{{ url_for('cancelled_analysis', quick_date='all', source=source_filter, manager=manager_filter) }}"
                class="btn btn-month btn-month-all {% if quick_date == 'all' and not current_month %}active{% endif %}">
                <i class="bi bi-collection me-1"></i>å…¨éƒ¨
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Styles for month buttons -->
    <style>
        /* Month button styling */
        .btn-month {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.4);
            color: #a0aec0;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-month:hover {
            background: rgba(102, 126, 234, 0.25);
            border-color: #667eea;
            color: #e2e8f0;
            transform: translateY(-2px);
        }

        .btn-month.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-month-all {
            border-color: rgba(236, 72, 153, 0.5);
            background: rgba(236, 72, 153, 0.15);
            color: #ec4899;
        }

        .btn-month-all:hover {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.25);
            color: #f687b3;
        }

        .btn-month-all.active {
            background: linear-gradient(135deg, #ec4899, #f97316);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
            color: white;
        }
    </style>
</div>
{% endblock %}

{% block scripts %}
<script>
    function applyFilters() {
        var month = document.getElementById('monthFilter').value;
        var manager = document.getElementById('managerFilter').value;
        var source = document.getElementById('sourceFilter').value;

        var params = new URLSearchParams();
        // If month is selected, use month filter; otherwise keep quick_date
        if (month) {
            params.set('month', month);
        } else {
            params.set('quick_date', '{{ quick_date or "this_month" }}');
        }
        if (manager) params.set('manager', manager);
        if (source) params.set('source', source);

        window.location.href = '{{ url_for("cancelled_analysis") }}?' + params.toString();
    }
</script>
{% endblock %}